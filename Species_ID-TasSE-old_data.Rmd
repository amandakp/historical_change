---
title: "Species ID - Edgar & Samson 2000/2001 cores"
author: Amanda Pettersen
date: "`r format(Sys.Date(),'%e %B, %Y')`"
output:
  pdf_document:
    toc: yes
  word_document:
    toc: yes
  html_document:
    toc_float: yes
    toc: yes
    html_document: null
---

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
pacman::p_load(tidyverse, dplyr, ggplot2, patchwork, vegan, lme4, emmeans, ggeffects, patchwork, scales, multcomp, ggrepel, glmmTMB, performance)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#Locate files
data_files_paths <- file.path("data/", list.files("data/"))
list.files("data/") 
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#Load csv files
file_dentrecasteaux <- 'Data/Impacts data matrix ( MDS)-AP_Dentrecasteaux.csv'
file_derwent <- 'Data/Impacts data matrix ( MDS)-AP_Derwent.csv'
file_huon <- 'Data/Impacts data matrix ( MDS)-AP_Huon.csv'

#Read csv files into dataframes
df_dentrecasteaux <- read.csv(file_dentrecasteaux, stringsAsFactors = FALSE, check.names = FALSE)
df_derwent <- read.csv(file_derwent, stringsAsFactors = FALSE, check.names = FALSE)
df_huon <- read.csv(file_huon, stringsAsFactors = FALSE, check.names = FALSE)

#Check column names to ensure 'Site Code' is read correctly
print(colnames(df_dentrecasteaux))
print(colnames(df_derwent))
print(colnames(df_huon))

#Ensure 'Site Code' is read as a character in all dataframes
df_dentrecasteaux$`Site Code` <- as.character(df_dentrecasteaux$`Site Code`)
df_derwent$`Site Code` <- as.character(df_derwent$`Site Code`)
df_huon$`Site Code` <- as.character(df_huon$`Site Code`)

#Check first few rows of each dataframe to ensure data is read correctly
print(head(df_dentrecasteaux))
print(head(df_derwent))
print(head(df_huon))

# #Merge dataframes by 'Site Code' - CAN'T MERGE BECAUSE FIRST 4 COLUMN NAMES ARE DIFFERENT
# merged_df <- full_join(df_dentrecasteaux, df_derwent, by = "Site Code")
# merged_df <- full_join(merged_df, df_huon, by = "Site Code")
# 
# #Replace NAs with 0
# merged_df[is.na(merged_df)] <- 0
# 
# #Save merged dataframe as a new CSV file
# write.csv(merged_df, 'Data/Allsites_sabund.csv', row.names = FALSE)
```

Species abundance for shallow depths (mid depth = 2.5cm)

#D'Entrecasteaux (DCS)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Filter dataframe for 'Faunal mid-depth' = 2.5
dcs_filtered <- df_dentrecasteaux %>% filter(`Faunal mid-depth` == 2.5)

#Remove non-species columns (species columns start from the 5th column)
species_abundanceDCS <- dcs_filtered[, 5:ncol(dcs_filtered)]

#Convert dataframe to long format for plotting
species_abundanceDCS_long <- species_abundanceDCS %>%
  pivot_longer(cols = everything(), names_to = "Species", values_to = "Abundance")
View(species_abundanceDCS_long)

#Remove species with zero abundance
species_abundanceDCS_long <- species_abundanceDCS_long %>% filter(Abundance > 0)

#Order species by abundance
species_abundanceDCS_long <- species_abundanceDCS_long %>%
  arrange(desc(Abundance))
#View(species_abundanceDCS_long)
#write.csv(species_abundanceDCS_long, "Data/species_abundanceDCS_long.csv")

#Plot species abundance
pDCS <- ggplot(species_abundanceDCS_long, aes(x = reorder(Species, -Abundance), y = Abundance)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "D'Entrecasteaux Species abundance (mid-depth 2.5cm)",
       x = "Species",
       y = "Abundance")
pDCS
```

#Separate by "Site Code" for DCS (IPHC-8, IPHC-10, IPHC-25, IPHC-28, IPHC-29, IPHC-30) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only):

#Site 1/6 (DCS): IPHC-8 SHELTER COVE, BRUNY ISLAND
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Define site code and depths of interest
Site_codes <- c("IPHC-8")
depths <- c(2.5, 12.5, 22.5)

# Filter data
df_filtered <- df_dentrecasteaux %>%
  filter(`Site Code` %in% Site_codes,
         `Faunal mid-depth` %in% depths)

# Convert to long format
species_abundance_long <- df_filtered %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Put Species as factor so it doesn't auto-order globally
species_abundance_long$Species <- factor(species_abundance_long$Species)

# Plot with facetting
p_all_iphc8 <- ggplot(species_abundance_long, aes(x = Species, y = Abundance)) +
  geom_bar(stat = "identity") +
  facet_grid(`Site Code` ~ `Faunal mid-depth`, scales = "free_y") +
  #facet_wrap(~ `Site Code` + `Faunal mid-depth`, scales = "free_y", ncol = 3) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6),
    strip.text = element_text(size = 10),
    panel.spacing = unit(0.8, "lines"),
    axis.title.x = element_text(margin = margin(t = 10))
  ) +
  labs(title = "Species abundance by site and Faunal mid-depth",
       x = "Species",
       y = "Abundance")

p_all_iphc8
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for only Site Code IPHC-8 and depths of interest
df_iphc8 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-8",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc8_long <- df_iphc8 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Make sure Species is a factor
iphc8_long$Species <- factor(iphc8_long$Species)

# Plot with custom fill colors
p_iphc8 <- ggplot(iphc8_long, aes(x = Species, y = Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance at IPHC-8 (by Faunal mid-depth)",
    x = "Species",
    y = "Abundance"
  )

p_iphc8
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-8 and relevant depths
df_iphc8 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-8",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc8_long <- df_iphc8 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc8_relative <- iphc8_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc8_relative$Species <- factor(iphc8_relative$Species)

# Plot relative abundance
p_iphc8_rel <- ggplot(iphc8_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-8 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc8_rel #relative order of species abundance doesn't change from 22.5cm (~120ya) to 2.5cm (~7 ya)
```

#Site 2/6 (DCS): IPHC-10 OYSTER COVE
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-10 and relevant depths
df_iphc10 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-10",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc10_long <- df_iphc10 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc10_relative <- iphc10_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc10_relative$Species <- factor(iphc10_relative$Species)

# Plot relative abundance
p_iphc10_rel <- ggplot(iphc10_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-10 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc10_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~50ya) to Corbula at 2.5cm (~4.5 ya). 
```

#Site 3/6 (DCS): IPHC-25 BIRCHS BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-25 and relevant depths
df_iphc25 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-25",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc25_long <- df_iphc25 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc25_relative <- iphc25_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc25_relative$Species <- factor(iphc25_relative$Species)

# Plot relative abundance
p_iphc25_rel <- ggplot(iphc25_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-25 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc25_rel #relative order of species abundance changes from Nemocardium and Chioneryx at 22.5cm (~70ya) to Corbula at 2.5cm (~7 ya). 
```

#Site 4/6 (DCS): IPHC-28 APOLLO BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-28 and relevant depths
df_iphc28 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-28",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc28_long <- df_iphc28 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc28_relative <- iphc28_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc28_relative$Species <- factor(iphc28_relative$Species)

# Plot relative abundance
p_iphc28_rel <- ggplot(iphc28_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-28 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc28_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~55ya) to Corbula at 2.5cm (~6 ya). 
```

#Site 5/6 (DCS): IPHC-29 TRIAL BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-29 and relevant depths
df_iphc29 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-29",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc29_long <- df_iphc29 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc29_relative <- iphc29_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc29_relative$Species <- factor(iphc29_relative$Species)

# Plot relative abundance
p_iphc29_rel <- ggplot(iphc29_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-29 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc29_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~50ya) to Corbula at 2.5cm (~6 ya). 
```

#Site 6/6 (DCS): IPHC-30 APOLLO BAY (LITTLE OYSTER COVE, KETTERING)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-30 and relevant depths
df_iphc30 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-30",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc30_long <- df_iphc30 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc30_relative <- iphc30_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc30_relative$Species <- factor(iphc30_relative$Species)

# Plot relative abundance
p_iphc30_rel <- ggplot(iphc30_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-30 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc30_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~40ya) to Corbula at 2.5cm (~1.5 ya). 
```
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Combine DCS plots for IPHC-8, IPHC-10, IPHC-25, IPHC-28, IPHC-29, IPHC-30) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only) into one panel

# Standardize the look of all plots
plots_list <- list(
  p_iphc8_rel + labs(title = "IPHC-8") + theme(legend.position = "none"),
  p_iphc10_rel + labs(title = "IPHC-10") + theme(legend.position = "none"),
  p_iphc25_rel + labs(title = "IPHC-25") + theme(legend.position = "none"),
  p_iphc28_rel + labs(title = "IPHC-28") + theme(legend.position = "none"),
  p_iphc29_rel + labs(title = "IPHC-29") + theme(legend.position = "none"),
  p_iphc30_rel + labs(title = "IPHC-30") + theme(legend.position = "none")
)

# Combine in a 2-column, 3-row layout with consistent axis formatting
combined_plot <- wrap_plots(plots_list, ncol = 2, guides = "collect") +
  plot_annotation(
    title = "Relative Species Abundance at Selected Sites",
    tag_levels = "A",
    tag_prefix = "",
    tag_suffix = ")"
  ) & 
  labs(y = "Relative\nabundance") &  # Two-line y-axis label here
  theme(
    plot.tag = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.position = "bottom"
  )

# Show it
combined_plot

ggsave("combined_plot.png", combined_plot, width = 12, height = 10, dpi = 300)
```


#Derwent (DER)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Filter dataframe for 'Faunal mid-depth' = 2.5
der_filtered <- df_derwent %>% filter(`Mid-depth` == 2.5)

#Remove non-species columns (species columns start from the 5th column)
species_abundanceDER <- der_filtered[, 5:ncol(der_filtered)]

#Convert dataframe to long format for plotting
species_abundanceDER_long <- species_abundanceDER %>%
  pivot_longer(cols = everything(), names_to = "Species", values_to = "Abundance")
View(species_abundanceDER_long)

#Remove species with zero abundance
species_abundanceDER_long <- species_abundanceDER_long %>% filter(Abundance > 0)

#Order species by abundance
species_abundanceDER_long <- species_abundanceDER_long %>%
  arrange(desc(Abundance))
#View(species_abundanceDER_long)
#write.csv(species_abundanceDER_long, "Data/species_abundanceDER_long.csv")

#Plot species abundance
pDER <- ggplot(species_abundanceDER_long, aes(x = reorder(Species, -Abundance), y = Abundance)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Derwent Species abundance (mid-depth 2.5cm)",
       x = "Species",
       y = "Abundance")
pDER
```

#Separate by "Site Code" for DCS (IPHC-8, IPHC-10, IPHC-25, IPHC-28, IPHC-29, IPHC-30) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only):

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Define site code and depths of interest
Site_codes <- c("IPHC-12")
depths <- c(2.5, 12.5, 22.5)

# Filter data
der_filtered <- df_derwent %>%
  filter(`Site Code` %in% Site_codes,
         `Mid-depth` %in% depths)

# Convert to long format
species_abundance_long <- der_filtered %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Put Species as factor so it doesn't auto-order globally
species_abundance_long$Species <- factor(species_abundance_long$Species)

# Plot with facetting
p_all_iphc12 <- ggplot(species_abundance_long, aes(x = Species, y = Abundance)) +
  geom_bar(stat = "identity") +
  facet_grid(`Site Code` ~ `Mid-depth`, scales = "free_y") +
  #facet_wrap(~ `Site Code` + `Faunal mid-depth`, scales = "free_y", ncol = 3) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6),
    strip.text = element_text(size = 10),
    panel.spacing = unit(0.12, "lines"),
    axis.title.x = element_text(margin = margin(t = 10))
  ) +
  labs(title = "Species abundance by site and Faunal mid-depth",
       x = "Species",
       y = "Abundance")

p_all_iphc12
```

#Site 1/4 (DER): IPHC-12 RALPHS BAY ENTRANCE
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for only Site Code IPHC-12 and depths of interest
df_iphc12 <- df_derwent %>%
  filter(`Site Code` == "IPHC-12",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc12_long <- df_iphc12 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Make sure Species is a factor
iphc12_long$Species <- factor(iphc12_long$Species)

# Plot with custom fill colors
p_iphc12 <- ggplot(iphc12_long, aes(x = Species, y = Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance at IPHC-12 (by Faunal mid-depth)",
    x = "Species",
    y = "Abundance"
  )

p_iphc12
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-12 and relevant depths
df_iphc12 <- df_derwent %>%
  filter(`Site Code` == "IPHC-12",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc12_long <- df_iphc12 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc12_relative <- iphc12_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc12_relative$Species <- factor(iphc12_relative$Species)

# Plot relative abundance
p_iphc12_rel <- ggplot(iphc12_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-12 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc12_rel #dominant species remains Theora lubrica from 22.5cm (~50ya) to 2.5cm (~8 ya). Introduction of Hiatella australis and disappearance of Chioneryx, Corbula, and Nelio australis in past 30 years.
```

#Site 2/4 (DER): IPHC-13 NORTH END RALPHS BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-13 and relevant depths
df_iphc13 <- df_derwent %>%
  filter(`Site Code` == "IPHC-13",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc13_long <- df_iphc13 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc13_relative <- iphc13_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc13_relative$Species <- factor(iphc13_relative$Species)

# Plot relative abundance
p_iphc13_rel <- ggplot(iphc13_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-13 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc13_rel #Reduction in Chioneryx from ~40% at 22.5cm (~105 ya) to ~15% at 2.5cm (~24ya). Corbula dominates in recent years (35%). Also sudden increase of Agatha simplex and appearance of Ostrea angasi.
```

#Site 3/4 (DER): IPHC-15 KANGAROO BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-15 and relevant depths
df_iphc15 <- df_derwent %>%
  filter(`Site Code` == "IPHC-15",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc15_long <- df_iphc15 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc15_relative <- iphc15_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc15_relative$Species <- factor(iphc15_relative$Species)

# Plot relative abundance
p_iphc15_rel <- ggplot(iphc15_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-15 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc15_rel #Reduction in Chioneryx from ~25% at 22.5cm (~83 ya) to ~10% at 2.5cm (~12 ya). Increase in Theora lubrica from ~5% to ~40% and appearance of Biv DB(?) in recent sample. No corbula?
```

#Site 4/4 (DER): IPHC-22 TRANMERE
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-22 and relevant depths
df_iphc22 <- df_derwent %>%
  filter(`Site Code` == "IPHC-22",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc22_long <- df_iphc22 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc22_relative <- iphc22_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc22_relative$Species <- factor(iphc22_relative$Species)

# Plot relative abundance
p_iphc22_rel <- ggplot(iphc22_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-22 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc22_rel #Reduction in Chioneryx from ~38% at 22.5cm (~85 ya) to ~10% at 2.5cm (~10 ya). Increase in Placamen placidum from ~2% to ~35%, Nemocardium (15% to 25%), and Nucula (1% to 10%), and appearance of Corbula (~6%) in recent sample.
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Combine DER plots for IPHC-12, IPHC-13, IPHC-15, IPHC-22) and "Mid-depth" (2.5, 12.5, and 22.5 only) into one panel

# Standardize the look of all plots
plots_list <- list(
  p_iphc12_rel + labs(title = "IPHC-12") + theme(legend.position = "none"),
  p_iphc13_rel + labs(title = "IPHC-13") + theme(legend.position = "none"),
  p_iphc15_rel + labs(title = "IPHC-15") + theme(legend.position = "none"),
  p_iphc22_rel + labs(title = "IPHC-22") + theme(legend.position = "none")
)

# Combine in a 2-column, 2-row layout with consistent axis formatting
combined_plot <- wrap_plots(plots_list, ncol = 2, guides = "collect") +
  plot_annotation(
    title = "Relative Species Abundance at Selected Sites",
    tag_levels = "A",
    tag_prefix = "",
    tag_suffix = ")"
  ) & 
  labs(y = "Relative\nabundance") &  # Two-line y-axis label here
  theme(
    plot.tag = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.position = "bottom"
  )

# Show it
combined_plot

ggsave("combined_plot_DER.png", combined_plot, width = 12, height = 10, dpi = 300)
```


#Huon (HUO)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Filter dataframe for 'Faunal mid-depth' = 2.5
huo_filtered <- df_huon %>% filter(`Faunal mid-depth` == 2.5)

#Remove non-species columns (species columns start from the 5th column)
species_abundanceHUO <- huo_filtered[, 5:ncol(huo_filtered)]

#Convert dataframe to long format for plotting
species_abundanceHUO_long <- species_abundanceHUO %>%
  pivot_longer(cols = everything(), names_to = "Species", values_to = "Abundance")
View(species_abundanceHUO_long)

#Remove species with zero abundance
species_abundanceHUO_long <- species_abundanceHUO_long %>% filter(Abundance > 0)

#Order species by abundance
species_abundanceHUO_long <- species_abundanceHUO_long %>%
  arrange(desc(Abundance))

#Plot species abundance
pHUO <- ggplot(species_abundanceHUO_long, aes(x = reorder(Species, -Abundance), y = Abundance)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Huon Species abundance (mid-depth 2.5cm)",
       x = "Species",
       y = "Abundance")
pHUO
```

#Separate by "Site Code" for HUO (IPHC-31, IPHC-33) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only):

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Define site code and depths of interest
Site_codes <- c("IPHC-31")
depths <- c(2.5, 12.5, 22.5)

# Filter data
der_filtered <- df_huon %>%
  filter(`Site Code` %in% Site_codes,
         `Faunal mid-depth` %in% depths)

# Convert to long format
species_abundance_long <- huo_filtered %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Put Species as factor so it doesn't auto-order globally
species_abundance_long$Species <- factor(species_abundance_long$Species)

# Plot with facetting
p_all_iphc31 <- ggplot(species_abundance_long, aes(x = Species, y = Abundance)) +
  geom_bar(stat = "identity") +
  facet_grid(`Site Code` ~ `Faunal mid-depth`, scales = "free_y") +
  #facet_wrap(~ `Site Code` + `Faunal mid-depth`, scales = "free_y", ncol = 3) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6),
    strip.text = element_text(size = 10),
    panel.spacing = unit(0.31, "lines"),
    axis.title.x = element_text(margin = margin(t = 10))
  ) +
  labs(title = "Species abundance by site and Faunal mid-depth",
       x = "Species",
       y = "Abundance")

p_all_iphc31
```

#Site 1/4 (HUO): IPHC-31 PETCHYS BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for only Site Code IPHC-31 and depths of interest
df_iphc31 <- df_huon %>%
  filter(`Site Code` == "IPHC-31",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc31_long <- df_iphc31 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Make sure Species is a factor
iphc31_long$Species <- factor(iphc31_long$Species)

# Plot with custom fill colors
p_iphc31 <- ggplot(iphc31_long, aes(x = Species, y = Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#E6CCFF",  # light lavender
      "12.5" = "#A259FF", # medium vibrant purple
      "22.5" = "#4B0082"  # deep indigo
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance at IPHC-31 (by Faunal mid-depth)",
    x = "Species",
    y = "Abundance"
  )

p_iphc31
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-31 and relevant depths
df_iphc31 <- df_huon %>%
  filter(`Site Code` == "IPHC-31",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc31_long <- df_iphc31 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc31_relative <- iphc31_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc31_relative$Species <- factor(iphc31_relative$Species)

# Plot relative abundance
p_iphc31_rel <- ggplot(iphc31_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#E6CCFF",  # light lavender
      "12.5" = "#A259FF", # medium vibrant purple
      "22.5" = "#4B0082"  # deep indigo
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-31 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc31_rel #Loss of Nemocardium from 22.5cm (~545 ya) and Hiatella and Pecten fumatus from 12.5cm (~45 ya) to 2.5cm (~15 ya). Increase in Corbula and appearance of Theora in past ~45 years.
```

#Site 1/4 (HUO): IPHC-33 PORT CYGNET

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-33 and relevant depths
df_iphc33 <- df_huon %>%
  filter(`Site Code` == "IPHC-33",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc33_long <- df_iphc33 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc33_relative <- iphc33_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc33_relative$Species <- factor(iphc33_relative$Species)

# Plot relative abundance
p_iphc33_rel <- ggplot(iphc33_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#E6CCFF",  # light lavender
      "12.5" = "#A259FF", # medium vibrant purple
      "22.5" = "#4B0082"  # deep indigo
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-33 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc33_rel #Loss of Nemocardium from 22.5cm (~545 ya) and Hiatella and Pecten fumatus from 12.5cm (~45 ya) to 2.5cm (~15 ya). Increase in Corbula and appearance of Theora in past ~45 years.
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Combine DCS plots for IPHC-31, IPHC-33 and "Faunal mid-depth" (2.5, 12.5, and 22.5 only) into one panel

# Standardize the look of all plots
plots_list <- list(
  p_iphc31_rel + labs(title = "IPHC-31") + theme(legend.position = "none"),
  p_iphc33_rel + labs(title = "IPHC-33") + theme(legend.position = "none")
)

# Combine in a 2-column, 3-row layout with consistent axis formatting
combined_plot <- wrap_plots(plots_list, ncol = 2, guides = "collect") +
  plot_annotation(
    title = "Relative Species Abundance at Selected Sites",
    tag_levels = "A",
    tag_prefix = "",
    tag_suffix = ")"
  ) & 
  labs(y = "Relative\nabundance") &  # Two-line y-axis label here
  theme(
    plot.tag = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.position = "bottom"
  )

# Show it
combined_plot

ggsave("combined_plot_HUO.png", combined_plot, width = 12, height = 10, dpi = 300)
```






#NEW DATA: SE TAS SAMPLES 2024

#1. LONG CORE SAMPLES: DEATH ASSEMBLAGE ANALYSIS

#Data visualisation

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Load and prepare data
df <- read.csv("Data/Data_entry_SETas2024-Cores.csv")

# Define color mapping for Site_location
location_colors <- c(
  "DEntrecasteaux" = "#FFA500",
  "Derwent" = "#1E90FF",
  "Huon" = "#A259FF"
)

# Filter: Dead condition, named species, and only abundance > 0
dead_data <- df %>%
  filter(Condition == "Dead", !is.na(Species_name), Abundance > 0)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Summarise total abundance and species richness per site and depth
summary_data <- dead_data %>%
  group_by(Site_location, Site_code, Mid_depth_cm) %>%
  summarise(
    Total_abundance = sum(Abundance),
    Species_richness = n_distinct(Species_name),
    .groups = "drop"
  )

# Compute mean lines per location
location_means <- summary_data %>%
  group_by(Site_location, Mid_depth_cm) %>%
  summarise(
    Mean_abundance = mean(Total_abundance),
    Mean_richness = mean(Species_richness),
    .groups = "drop"
  )

# Get label positions (shallowest depth only)
site_labels_abund <- summary_data %>%
  dplyr::filter(Mid_depth_cm == min(Mid_depth_cm)) %>%
  dplyr::select(Site_location, Site_code, Mid_depth_cm, Total_abundance)

site_labels_rich <- summary_data %>%
  dplyr::filter(Mid_depth_cm == min(Mid_depth_cm)) %>%
  dplyr::select(Site_location, Site_code, Mid_depth_cm, Species_richness)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Plot 1: Abundance ###
plot_abundance <- ggplot() +
  geom_line(data = summary_data,
            aes(x = Mid_depth_cm, y = Total_abundance,
                group = Site_code, color = Site_location),
            linetype = "dotted") +
  geom_line(data = location_means,
            aes(x = Mid_depth_cm, y = Mean_abundance,
                group = Site_location, color = Site_location),
            size = 1) +
  geom_text_repel(data = site_labels_abund,
                  aes(x = Mid_depth_cm, y = Total_abundance, label = Site_code, color = Site_location),
                  size = 3, nudge_x = 1, direction = "y", hjust = 0, segment.color = NA) +
  facet_wrap(~ Site_location) +
  scale_color_manual(values = location_colors) +
  scale_x_reverse() +
  labs(
    x = "Mid-depth in core (cm)",
    y = "Total shell abundance",
    title = "A)"
  ) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Plot 2: Species Richness ###
plot_richness <- ggplot() +
  geom_line(data = summary_data,
            aes(x = Mid_depth_cm, y = Species_richness,
                group = Site_code, color = Site_location),
            linetype = "dotted") +
  geom_line(data = location_means,
            aes(x = Mid_depth_cm, y = Mean_richness,
                group = Site_location, color = Site_location),
            size = 1) +
  geom_text_repel(data = site_labels_rich,
                  aes(x = Mid_depth_cm, y = Species_richness, label = Site_code, color = Site_location),
                  size = 3, nudge_x = 1, direction = "y", hjust = 0, segment.color = NA) +
  facet_wrap(~ Site_location) +
  scale_color_manual(values = location_colors) +
  scale_x_reverse() +
  labs(
    x = "Mid-depth in core (cm)",
    y = "Species richness",
    title = "B)"
  ) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Combine with patchwork
combined_plot <- plot_abundance / plot_richness

# Print combined plot
print(combined_plot)

ggsave("plot_abundrich_cores.png", combined_plot, width = 12, height = 10, dpi = 300)
```


#Data analysis:

#Generalised linear models (GLMM) to test whether dead abundance and species richness vary with Mid_depth_cm, Sieve_size_mm, Site_location, and Site_code, for count or non-normal data.
#Abundance (may require log or Poisson/negative binomial)
#Richness (count: Poisson or negative binomial)

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter dead data with abundance > 0
dead_data <- df %>%
  filter(Condition == "Dead", !is.na(Species_name), Abundance > 0)

# Summarise abundance and richness per sample unit
summary_data <- dead_data %>%
  group_by(Site_location, Site_code, Mid_depth_cm, Sieve_size_mm) %>%
  summarise(
    Total_abundance = sum(Abundance),
    Species_richness = n_distinct(Species_name),
    .groups = "drop"
  )

summary_data
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Poisson GLMM
mod_rich_pois <- glmmTMB(Species_richness ~ Mid_depth_cm * Sieve_size_mm * Site_location +
                           (1 | Site_code),
                         data = summary_data,
                         family = poisson())

# Check overdispersion
check_overdispersion(mod_rich_pois) #no overdispersion detected

summary(mod_rich_pois)

# # Try Negative Binomial if overdispersed
# mod_rich_nb <- glmmTMB(Species_richness ~ Mid_depth_cm * Sieve_size_mm * Site_location +
#                          (1 | Site_code),
#                        data = summary_data,
#                        family = nbinom2())

# summary(mod_rich_pois)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
mod_abund <- glmmTMB(Total_abundance ~ Mid_depth_cm * Sieve_size_mm * Site_location +
                       (1 | Site_code),
                     data = summary_data,
                     family = nbinom2())

summary(mod_abund)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```









#2. VAN VEEN GRAB SAMPLES: LIVE-DEAD DISCORDANCE ANALYSIS

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Locate files
data_files_paths <- file.path("data/", list.files("data/"))
list.files("data/") 
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#Load csv files
file_livedead <- 'Data/Data_entry_SETas2024-VV_grab.csv'

#Read csv file into dataframe
df_livedead <- read.csv(file_livedead, stringsAsFactors = FALSE, check.names = FALSE)
str(df_livedead)
View(df_livedead)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Summarise total abundance
abundance_summary <- df_livedead %>%
  group_by(Site_location, Site_code, Sieve_size_mm, Condition, Species_name) %>%
  summarise(Total_abundance = sum(Abundance, na.rm = TRUE), .groups = "drop") %>%
  arrange(Site_location, Site_code, Sieve_size_mm, Condition, Species_name)

# View the result
head(abundance_summary)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Plot
ggplot(abundance_summary, aes(x = Site_code, y = Total_abundance, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Live" = "#8FBC8F", "Dead" = "#CD5C5C")) +
  labs(title = "Live vs Dead Abundance by Site",
       x = "Site Code",
       y = "Total Abundance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Plot
ggplot(abundance_summary, aes(x = Species_name, y = Total_abundance, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Live" = "#8FBC8F", "Dead" = "#CD5C5C")) +
  labs(title = "Live vs Dead Abundance by Species",
       x = "Species",
       y = "Total Abundance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for 2.8mm sieve size
abundance_summary2.8mm <- abundance_summary %>%
  filter(`Sieve_size_mm` == "2.8")

ggplot(abundance_summary2.8mm, aes(x = Species_name, y = Total_abundance, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Live" = "#8FBC8F", "Dead" = "#CD5C5C")) +
  labs(title = "Live vs Dead Abundance by Species (2.8mm sieve)",
       x = "Species",
       y = "Total Abundance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Read in your dataset
df <- read_csv("Data/Data_entry_SETas2024-VV_grab.csv")

# Inspect structure
glimpse(df)

# Ensure key columns are factors
df <- df %>%
  mutate(across(c(Site_code, Site_location, Sieve_size_mm, Replicate, Condition, Species_code), as.factor))

# Pivot to wide form: one row per Replicate per group, one column per species
comm_data <- df %>%
  group_by(Site_code, Site_location, Sieve_size_mm, Replicate, Condition, Species_code) %>%
  summarise(abundance = sum(Abundance), .groups = "drop") %>%
  pivot_wider(names_from = Species_code, values_from = abundance, values_fill = 0)

# Create a unique ID for grouping
comm_data <- comm_data %>%
  unite("group_id", Site_code, Site_location, Sieve_size_mm, Replicate, remove = FALSE)

# Split into live and dead matrices
live_matrix <- comm_data %>% filter(Condition == "Live")
dead_matrix <- comm_data %>% filter(Condition == "Dead")

# Ensure same row order for paired comparisons
live_matrix <- live_matrix %>% arrange(group_id)
dead_matrix <- dead_matrix %>% arrange(group_id)

# Keep only the species columns
species_cols <- setdiff(names(live_matrix), c("Site_code", "Site_location", "Sieve_size_mm", "Replicate", "Condition", "group_id"))
live_species <- live_matrix[, species_cols]
dead_species <- dead_matrix[, species_cols]

# Compute live-dead dissimilarity (Bray-Curtis) for each Replicate
discordance <- vegan::vegdist(rbind(live_species, dead_species), method = "bray")
n <- nrow(live_species)
discordance_values <- diag(as.matrix(discordance)[1:n, (n+1):(2*n)])

# Combine metadata with results
results_df <- live_matrix %>%
  dplyr::select(Site_code, Site_location, Sieve_size_mm, Replicate, group_id) %>%
  mutate(live_dead_dissimilarity = discordance_values)

```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📊 Visualisations
# ─────────────────────────────────────────────────────

# Boxplot by Site_code
ggplot(results_df, aes(x = Site_code, y = live_dead_dissimilarity)) +
  geom_boxplot() +
  labs(title = "Live-Dead Dissimilarity by Site", y = "Bray-Curtis Dissimilarity")

# Boxplot by Site_location
ggplot(results_df, aes(x = Site_location, y = live_dead_dissimilarity)) +
  geom_boxplot() +
  labs(title = "Live-Dead Dissimilarity by Location", y = "Bray-Curtis Dissimilarity")

# Boxplot by sieve size
ggplot(results_df, aes(x = as.factor(Sieve_size_mm), y = live_dead_dissimilarity)) +
  geom_boxplot() +
  labs(title = "Live-Dead Dissimilarity by Sieve Size", x = "Sieve Size (mm)", y = "Bray-Curtis Dissimilarity")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📈 Test effects with linear mixed effects models
# ─────────────────────────────────────────────────────

# Linear mixed model (Replicates are nested within sites)

#Fixed effects: test whether Site_code or sieve size significantly affect discordance.
#Random effects: account for non-independence due to repeated measures within sites and among replicates.
#Model overfitted so Site_location removed (plots seem to show no differences among locations)

# Ensure Replicate is a factor
results_df <- results_df %>%
  mutate(across(c(Site_code, Replicate, Sieve_size_mm), as.factor))

# Fit the mixed model
lmm <- lmer(live_dead_dissimilarity ~ Sieve_size_mm + Site_location +
              (1 | Site_code/Replicate),
            data = results_df)

# View results with p-values
summary(lmm)
#Sig effect of sieve size on discordance. No sig effect of site or site location

# Marginal means for sieve size
emmeans(lmm, pairwise ~ Sieve_size_mm)
#2.8mm discordance sig > 1mm and 1.4mm
#4mm discordance sig > 1mm and 1.4mm

# Marginal means for Site_code
emmeans(lmm, pairwise ~ Site_code)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📊 Visualisations
# ─────────────────────────────────────────────────────
# Predicted values
pred_sieve <- ggpredict(lmm, terms = "Sieve_size_mm")  # uses levels as factor
pred_location <- ggpredict(lmm, terms = "Site_location")

# Convert sieve size to numeric for color gradient
results_df$sieve_size_mm_num <- as.numeric(as.character(results_df$Sieve_size_mm))

# For sieve size
emm_sieve <- emmeans(lmm, ~ Sieve_size_mm)
cld_sieve <- cld(emm_sieve, Letters = letters, adjust = "tukey")

# For site location
emm_location <- emmeans(lmm, ~ Site_location)
cld_location <- cld(emm_location, Letters = letters, adjust = "tukey")

# Find max predicted value for each plot
max_y_sieve <- max(pred_sieve$conf.high, na.rm = TRUE)
max_y_location <- max(pred_location$conf.high, na.rm = TRUE)

# Add y position columns to group data
cld_sieve$y_pos <- max_y_sieve + 0.1
cld_location$y_pos <- max_y_location + 0.2
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# --- PLOT 1: Sieve size panel with group letters ---
plot_sieve <- ggplot(results_df, aes(x = Sieve_size_mm, y = live_dead_dissimilarity)) +
  annotate("text", x = -Inf, y = Inf, label = "A)", hjust = -0.2, vjust = 1.5, size = 6, fontface = "bold") +
  geom_boxplot(outlier.shape = NA, fill = "grey90", color = "black", linewidth = 1) +
  geom_jitter(aes(color = sieve_size_mm_num),
              width = 0.2, size = 3, alpha = 0.8) +
  geom_text(data = cld_sieve,
            aes(x = Sieve_size_mm, y = y_pos, label = .group),
            color = "black", size = 5, inherit.aes = FALSE) +
  scale_color_gradient(low = "#a8e6a3", high = "#006400") +
  labs(title = "Live-dead dissimilarity by sieve size",
       x = "Sieve Size (mm)", y = "Bray-Curtis Dissimilarity") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# --- PLOT 2: Site location panel with group letters ---
plot_location <- ggplot(results_df, aes(x = Site_location, y = live_dead_dissimilarity)) +
  annotate("text", x = -Inf, y = Inf, label = "B)", hjust = -0.2, vjust = 1.5, size = 6, fontface = "bold") +
  geom_boxplot(outlier.shape = NA, fill = "grey90", color = "black", linewidth = 1) +
  geom_jitter(aes(color = Site_location),
              width = 0.2, size = 3, alpha = 0.8) +
  geom_text(data = cld_location,
            aes(x = Site_location, y = y_pos, label = .group),
            color = "black", size = 5, inherit.aes = FALSE) +
  scale_color_manual(values = site_colors) +
  labs(title = "Live-dead dissimilarity by site location",
       x = "Site Location", y = "Bray-Curtis Dissimilarity") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
plot_predlivedead <- plot_sieve + plot_location
plot_predlivedead
ggsave("plot_predlivedead.png", plot_predlivedead, width = 12, height = 10, dpi = 300)
```

#All sieve sizes and replicates combined:

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📈 Test effects with ANOVA
# ─────────────────────────────────────────────────────

# ANOVA
#Fixed effects: test whether Site_code and Site_location significantly affect discordance independently of sieve size.

# Run the ANOVA
anova_model <- aov(live_dead_dissimilarity ~ Site_location + Site_code, data = results_df)

# ANOVA summary
summary(anova_model)
#Sig effect of Site_location on discordance. No sig effect of Site_code

# Estimated marginal means for Site_location
emm_location <- emmeans(anova_model, ~ Site_location)

# Pairwise comparisons with Tukey adjustment
pairwise_location <- contrast(emm_location, method = "pairwise", adjust = "tukey")

# View results
summary(pairwise_location)

# Compact letter display for plotting group differences
cld_location <- cld(emm_location, Letters = letters, adjust = "tukey")

# View group letters
print(cld_location)

```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📊 Visualisations
# ─────────────────────────────────────────────────────

# Define colors for Site_location
site_colors <- c("DEntrecasteaux" = "#FFA500",
                 "Derwent" = "#1E90FF",
                 "Huon" = "#A259FF")

# Desired order of Site_code
site_order <- c("IPHC10", "IPHC28", "IPHC15", "IPHC25", "IPHC31", "IPHC33")
# Apply order to the data frame
results_df$Site_code <- factor(results_df$Site_code, levels = site_order)


# Boxplot by Site_code (Panel 1)
plot_site <- ggplot(results_df, aes(x = Site_code, y = live_dead_dissimilarity, fill = Site_location)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.8) +
  scale_fill_manual(values = site_colors) +
  labs(x = "Site", y = "Bray-Curtis Dissimilarity") +
  theme_minimal() +
  theme(legend.position = "none")

# Boxplot by Site_location (Panel 2)
plot_location <- ggplot(results_df, aes(x = Site_location, y = live_dead_dissimilarity, fill = Site_location)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.8) +
  scale_fill_manual(values = site_colors) +
  labs(x = "Site Location", y = "Bray-Curtis Dissimilarity") +
  theme_minimal() +
  theme(legend.position = "none")

# Adjust y-position for clarity
max_y <- max(results_df$live_dead_dissimilarity, na.rm = TRUE)
cld_location$y_pos <- max_y + 0.05 * max_y

# Update plot with group letters
plot_location_letters <- plot_location +
  geom_text(data = cld_location,
            aes(x = Site_location, y = y_pos, label = .group),
            size = 4, color = "black")

plot_location_letters

# Combine panels
combined_plot <- plot_site + plot_location_letters
combined_plot

ggsave("plot_predlivedead_sites.png", combined_plot, width = 12, height = 10, dpi = 300)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}


```














#TO DO:

#Which species contribute most to live-dead discordance?

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#SIMPER Analysis for Live vs Dead Assemblages

#1. Prepare data
str(df_livedead)
df$Condition <- as.factor(df$Condition)

# Identify species columns programmatically
non_species_cols <- c("SampleID", "Site_code", "Site_location", "Sieve_size_mm",
                      "Replicate", "Condition", "live_dead")






species_data_raw <- results_df[, species_cols]

# Check which columns have non-numeric values
sapply(species_data_raw, function(col) any(!is.na(col) & !grepl("^\\d*(\\.\\d+)?$", as.character(col))))

# Create clean species matrix with numeric coercion
species_data <- species_data_raw %>%
  mutate(across(everything(), ~ suppressWarnings(as.numeric(as.character(.)))))

# Check how many NAs appeared
colSums(is.na(species_data))


#2. Run SIMPER analysis
# Run SIMPER to compare live vs dead
group_factor <- as.factor(results_df$live_dead)

simper_result <- simper(species_data, group_factor, permutations = 999)






#1. Prepare the community matrix
# Combine and label the assemblages
simper_data <- bind_rows(
  live_matrix %>% mutate(live_dead = "Live"),
  dead_matrix %>% mutate(live_dead = "Dead")
)

# Keep only species columns
species_matrix <- simper_data[, species_cols]

# Factor indicating live vs dead
group_factor <- simper_data$live_dead

#2. Run SIMPER analysis
simper_result <- vegan::simper(species_matrix, group_factor, permutations = 999)

# View results: this will show species, average contribution, standard deviation, etc.
summary(simper_result)

#3. Extract and visualise key contributors
# Extract results for Live vs Dead
ld_simper <- as.data.frame(simper_result$Live_Dead)

# Add species names
ld_simper$species <- rownames(ld_simper)

# Filter top contributors (e.g. cumulative contribution up to 70%)
top_contributors <- ld_simper %>%
  arrange(desc(average)) %>%
  mutate(cumsum = cumsum(average) / sum(average)) %>%
  filter(cumsum <= 0.7)

# Plot
ggplot(top_contributors, aes(x = reorder(species, average), y = average)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Top Species Contributing to Live-Dead Dissimilarity",
       x = "Species", y = "Average Contribution to Dissimilarity")
```


```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}


```




















