---
title: "Species ID - 2024 SE Tas long core and live-dead assemblage data"
author: Amanda Pettersen
date: "`r format(Sys.Date(),'%e %B, %Y')`"
output:
  pdf_document:
    toc: yes
  word_document:
    toc: yes
  html_document:
    toc_float: yes
    toc: yes
    html_document: null
---

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
pacman::p_load(tidyverse, dplyr, ggplot2, patchwork, vegan, lme4, emmeans, ggeffects, scales, multcomp, ggrepel, glmmTMB, performance, stringr)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#Locate files
data_files_paths <- file.path("data/", list.files("data/"))
list.files("data/") 
```
#NEW DATA: SE TAS SAMPLES 2024


#1. LONG CORE SAMPLES: DEATH ASSEMBLAGE ANALYSIS

#Data visualisation

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Load and prepare data
df <- read.csv("Data/Data_entry_SETas2024-Cores.csv")

# Define color mapping for Site_location
location_colors <- c(
  "DEntrecasteaux" = "#FFA500",
  "Derwent" = "#1E90FF",
  "Huon" = "#A259FF"
)

# Filter: Dead condition, named species, and only abundance > 0
dead_data <- df %>%
  filter(Condition == "Dead", !is.na(Species_name), Abundance > 0)
View(dead_data)

# Count unique species
n_unique_species_dead_data <- dead_data %>%
  filter(!is.na(`Species_name`)) %>%
  summarise(Unique_species = n_distinct(`Species_name`))

# View the result
n_unique_species_dead_data
```


Species abundance for shallow depths (mid depth = 2.5cm)

#Need to fix code for new data (19/5/25)....

#All site locations
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Plot with facetting and custom fill colors
pAllsitesabundnew <- ggplot(dead_data, aes(x = Species_name, y = Abundance, fill = factor(`Mid_depth_cm`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "lightgrey",  # light orange
      "12.5" = "darkgrey", # orange
      "22.5" = "black"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance (by Faunal mid-depth)",
    x = "Species",
    y = "Abundance"
  )

pAllsitesabundnew
```

#IPHC-8: Shelter Cove
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for only Site Code IPHC-8 and depths of interest
df_iphc8 <- dead_data %>%
  filter(`Site_code` == "IPHC33")

# Plot with facetting and custom fill colors
pAllsitesabundnewIPHC8 <- ggplot(df_iphc8, aes(x = Species_name, y = Abundance, fill = factor(`Mid_depth_cm`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance (by Faunal mid-depth): IPHC33",
    x = "Species",
    y = "Abundance"
  )

pAllsitesabundnewIPHC8
```


#D'Entrecasteaux (DCS)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Filter dataframe for Site_location' = 2.5
DCS_dead_data_2.5 <- dead_data %>% dplyr::filter(`Mid_depth_cm` == 2.5 & `Site_location` == "DEntrecasteaux")

#Filter dataframe for 'Faunal mid-depth' = 2.5 and 'Site_location' = DEntrecasteaux
DCS_dead_data_2.5 <- dead_data %>% dplyr::filter(`Mid_depth_cm` == 2.5 & `Site_location` == "DEntrecasteaux")


#Plot species abundance - old data (Edgar & Samson 2004 study)
pDCS <- ggplot(species_abundanceDCS_long, aes(x = reorder(Species, -Abundance), y = Abundance)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "D'Entrecasteaux Species abundance (mid-depth 2.5cm) 2000",
       x = "Species",
       y = "Abundance")
pDCS

#Plot species abundance - new data (2024 data)
pDCSnew <- ggplot(DCS_dead_data_2.5, aes(x = reorder(Species_name, -Abundance), y = Abundance)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "D'Entrecasteaux Species abundance (mid-depth 2.5cm) 2024",
       x = "Species",
       y = "Abundance")
pDCSnew


# Plot with facetting
pDCSnew <- ggplot(species_abundance_long, aes(x = Species_name, y = Abundance)) +
  geom_bar(stat = "identity") +
  facet_grid(`Site Code` ~ `Faunal mid-depth`, scales = "free_y") +
  #facet_wrap(~ `Site Code` + `Faunal mid-depth`, scales = "free_y", ncol = 3) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6),
    strip.text = element_text(size = 10),
    panel.spacing = unit(0.8, "lines"),
    axis.title.x = element_text(margin = margin(t = 10))
  ) +
  labs(title = "DCS Species abundance and Faunal mid-depth",
       x = "Species",
       y = "Abundance")

pDCSnew

```

#Separate by "Site Code" for DCS (IPHC-8, IPHC-10, IPHC-25, IPHC-28, IPHC-29, IPHC-30) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only):

#Site 1/6 (DCS): IPHC-8 SHELTER COVE, BRUNY ISLAND
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Define site code and depths of interest
Site_codes <- c("IPHC-8")
depths <- c(2.5, 12.5, 22.5)

# Filter data
df_filtered <- df_dentrecasteaux %>%
  filter(`Site Code` %in% Site_codes,
         `Faunal mid-depth` %in% depths)

# Convert to long format
species_abundance_long <- df_filtered %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Put Species as factor so it doesn't auto-order globally
species_abundance_long$Species <- factor(species_abundance_long$Species)

# Plot with facetting
p_all_iphc8 <- ggplot(species_abundance_long, aes(x = Species, y = Abundance)) +
  geom_bar(stat = "identity") +
  facet_grid(`Site Code` ~ `Faunal mid-depth`, scales = "free_y") +
  #facet_wrap(~ `Site Code` + `Faunal mid-depth`, scales = "free_y", ncol = 3) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6),
    strip.text = element_text(size = 10),
    panel.spacing = unit(0.8, "lines"),
    axis.title.x = element_text(margin = margin(t = 10))
  ) +
  labs(title = "Species abundance by site and Faunal mid-depth",
       x = "Species",
       y = "Abundance")

p_all_iphc8
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for only Site Code IPHC-8 and depths of interest
df_iphc8 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-8",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc8_long <- df_iphc8 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Make sure Species is a factor
iphc8_long$Species <- factor(iphc8_long$Species)

# Plot with custom fill colors
p_iphc8 <- ggplot(iphc8_long, aes(x = Species, y = Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance at IPHC-8 (by Faunal mid-depth)",
    x = "Species",
    y = "Abundance"
  )

p_iphc8
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-8 and relevant depths
df_iphc8 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-8",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc8_long <- df_iphc8 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc8_relative <- iphc8_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc8_relative$Species <- factor(iphc8_relative$Species)

# Plot relative abundance
p_iphc8_rel <- ggplot(iphc8_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-8 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc8_rel #relative order of species abundance doesn't change from 22.5cm (~120ya) to 2.5cm (~7 ya)
```

#Site 2/6 (DCS): IPHC-10 OYSTER COVE
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-10 and relevant depths
df_iphc10 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-10",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc10_long <- df_iphc10 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc10_relative <- iphc10_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc10_relative$Species <- factor(iphc10_relative$Species)

# Plot relative abundance
p_iphc10_rel <- ggplot(iphc10_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-10 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc10_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~50ya) to Corbula at 2.5cm (~4.5 ya). 
```

#Site 3/6 (DCS): IPHC-25 BIRCHS BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-25 and relevant depths
df_iphc25 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-25",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc25_long <- df_iphc25 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc25_relative <- iphc25_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc25_relative$Species <- factor(iphc25_relative$Species)

# Plot relative abundance
p_iphc25_rel <- ggplot(iphc25_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-25 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc25_rel #relative order of species abundance changes from Nemocardium and Chioneryx at 22.5cm (~70ya) to Corbula at 2.5cm (~7 ya). 
```

#Site 4/6 (DCS): IPHC-28 APOLLO BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-28 and relevant depths
df_iphc28 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-28",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc28_long <- df_iphc28 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc28_relative <- iphc28_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc28_relative$Species <- factor(iphc28_relative$Species)

# Plot relative abundance
p_iphc28_rel <- ggplot(iphc28_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-28 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc28_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~55ya) to Corbula at 2.5cm (~6 ya). 
```

#Site 5/6 (DCS): IPHC-29 TRIAL BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-29 and relevant depths
df_iphc29 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-29",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc29_long <- df_iphc29 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc29_relative <- iphc29_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc29_relative$Species <- factor(iphc29_relative$Species)

# Plot relative abundance
p_iphc29_rel <- ggplot(iphc29_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-29 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc29_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~50ya) to Corbula at 2.5cm (~6 ya). 
```

#Site 6/6 (DCS): IPHC-30 APOLLO BAY (LITTLE OYSTER COVE, KETTERING)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-30 and relevant depths
df_iphc30 <- df_dentrecasteaux %>%
  filter(`Site Code` == "IPHC-30",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc30_long <- df_iphc30 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc30_relative <- iphc30_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc30_relative$Species <- factor(iphc30_relative$Species)

# Plot relative abundance
p_iphc30_rel <- ggplot(iphc30_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#FFD580",  # light orange
      "12.5" = "#FFA500", # orange
      "22.5" = "#CC5500"  # dark orange
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-30 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc30_rel #relative order of species abundance changes from Chioneryx at 22.5cm (~40ya) to Corbula at 2.5cm (~1.5 ya). 
```
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Combine DCS plots for IPHC-8, IPHC-10, IPHC-25, IPHC-28, IPHC-29, IPHC-30) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only) into one panel

# Standardize the look of all plots
plots_list <- list(
  p_iphc8_rel + labs(title = "IPHC-8") + theme(legend.position = "none"),
  p_iphc10_rel + labs(title = "IPHC-10") + theme(legend.position = "none"),
  p_iphc25_rel + labs(title = "IPHC-25") + theme(legend.position = "none"),
  p_iphc28_rel + labs(title = "IPHC-28") + theme(legend.position = "none"),
  p_iphc29_rel + labs(title = "IPHC-29") + theme(legend.position = "none"),
  p_iphc30_rel + labs(title = "IPHC-30") + theme(legend.position = "none")
)

# Combine in a 2-column, 3-row layout with consistent axis formatting
combined_plot <- wrap_plots(plots_list, ncol = 2, guides = "collect") +
  plot_annotation(
    title = "Relative Species Abundance at Selected Sites",
    tag_levels = "A",
    tag_prefix = "",
    tag_suffix = ")"
  ) & 
  labs(y = "Relative\nabundance") &  # Two-line y-axis label here
  theme(
    plot.tag = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.position = "bottom"
  )

# Show it
combined_plot

ggsave("combined_plot.png", combined_plot, width = 12, height = 10, dpi = 300)
```


#Derwent (DER)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Filter dataframe for 'Faunal mid-depth' = 2.5
der_filtered <- df_derwent %>% filter(`Mid-depth` == 2.5)

#Remove non-species columns (species columns start from the 5th column)
species_abundanceDER <- der_filtered[, 5:ncol(der_filtered)]

#Convert dataframe to long format for plotting
species_abundanceDER_long <- species_abundanceDER %>%
  pivot_longer(cols = everything(), names_to = "Species", values_to = "Abundance")
View(species_abundanceDER_long)

#Remove species with zero abundance
species_abundanceDER_long <- species_abundanceDER_long %>% filter(Abundance > 0)

#Order species by abundance
species_abundanceDER_long <- species_abundanceDER_long %>%
  arrange(desc(Abundance))
#View(species_abundanceDER_long)
#write.csv(species_abundanceDER_long, "Data/species_abundanceDER_long.csv")

#Plot species abundance
pDER <- ggplot(species_abundanceDER_long, aes(x = reorder(Species, -Abundance), y = Abundance)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Derwent Species abundance (mid-depth 2.5cm)",
       x = "Species",
       y = "Abundance")
pDER
```

#Separate by "Site Code" for DCS (IPHC-8, IPHC-10, IPHC-25, IPHC-28, IPHC-29, IPHC-30) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only):

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Define site code and depths of interest
Site_codes <- c("IPHC-12")
depths <- c(2.5, 12.5, 22.5)

# Filter data
der_filtered <- df_derwent %>%
  filter(`Site Code` %in% Site_codes,
         `Mid-depth` %in% depths)

# Convert to long format
species_abundance_long <- der_filtered %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Put Species as factor so it doesn't auto-order globally
species_abundance_long$Species <- factor(species_abundance_long$Species)

# Plot with facetting
p_all_iphc12 <- ggplot(species_abundance_long, aes(x = Species, y = Abundance)) +
  geom_bar(stat = "identity") +
  facet_grid(`Site Code` ~ `Mid-depth`, scales = "free_y") +
  #facet_wrap(~ `Site Code` + `Faunal mid-depth`, scales = "free_y", ncol = 3) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6),
    strip.text = element_text(size = 10),
    panel.spacing = unit(0.12, "lines"),
    axis.title.x = element_text(margin = margin(t = 10))
  ) +
  labs(title = "Species abundance by site and Faunal mid-depth",
       x = "Species",
       y = "Abundance")

p_all_iphc12
```

#Site 1/4 (DER): IPHC-12 RALPHS BAY ENTRANCE
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for only Site Code IPHC-12 and depths of interest
df_iphc12 <- df_derwent %>%
  filter(`Site Code` == "IPHC-12",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc12_long <- df_iphc12 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Make sure Species is a factor
iphc12_long$Species <- factor(iphc12_long$Species)

# Plot with custom fill colors
p_iphc12 <- ggplot(iphc12_long, aes(x = Species, y = Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance at IPHC-12 (by Faunal mid-depth)",
    x = "Species",
    y = "Abundance"
  )

p_iphc12
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-12 and relevant depths
df_iphc12 <- df_derwent %>%
  filter(`Site Code` == "IPHC-12",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc12_long <- df_iphc12 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc12_relative <- iphc12_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc12_relative$Species <- factor(iphc12_relative$Species)

# Plot relative abundance
p_iphc12_rel <- ggplot(iphc12_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-12 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc12_rel #dominant species remains Theora lubrica from 22.5cm (~50ya) to 2.5cm (~8 ya). Introduction of Hiatella australis and disappearance of Chioneryx, Corbula, and Nelio australis in past 30 years.
```

#Site 2/4 (DER): IPHC-13 NORTH END RALPHS BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-13 and relevant depths
df_iphc13 <- df_derwent %>%
  filter(`Site Code` == "IPHC-13",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc13_long <- df_iphc13 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc13_relative <- iphc13_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc13_relative$Species <- factor(iphc13_relative$Species)

# Plot relative abundance
p_iphc13_rel <- ggplot(iphc13_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-13 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc13_rel #Reduction in Chioneryx from ~40% at 22.5cm (~105 ya) to ~15% at 2.5cm (~24ya). Corbula dominates in recent years (35%). Also sudden increase of Agatha simplex and appearance of Ostrea angasi.
```

#Site 3/4 (DER): IPHC-15 KANGAROO BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-15 and relevant depths
df_iphc15 <- df_derwent %>%
  filter(`Site Code` == "IPHC-15",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc15_long <- df_iphc15 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc15_relative <- iphc15_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc15_relative$Species <- factor(iphc15_relative$Species)

# Plot relative abundance
p_iphc15_rel <- ggplot(iphc15_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-15 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc15_rel #Reduction in Chioneryx from ~25% at 22.5cm (~83 ya) to ~10% at 2.5cm (~12 ya). Increase in Theora lubrica from ~5% to ~40% and appearance of Biv DB(?) in recent sample. No corbula?
```

#Site 4/4 (DER): IPHC-22 TRANMERE
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-22 and relevant depths
df_iphc22 <- df_derwent %>%
  filter(`Site Code` == "IPHC-22",
         `Mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc22_long <- df_iphc22 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc22_relative <- iphc22_long %>%
  group_by(`Mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc22_relative$Species <- factor(iphc22_relative$Species)

# Plot relative abundance
p_iphc22_rel <- ggplot(iphc22_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#ADD8E6",  # light blue
      "12.5" = "#1E90FF", # dodger blue
      "22.5" = "#003366"  # dark navy blue
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-22 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc22_rel #Reduction in Chioneryx from ~38% at 22.5cm (~85 ya) to ~10% at 2.5cm (~10 ya). Increase in Placamen placidum from ~2% to ~35%, Nemocardium (15% to 25%), and Nucula (1% to 10%), and appearance of Corbula (~6%) in recent sample.
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Combine DER plots for IPHC-12, IPHC-13, IPHC-15, IPHC-22) and "Mid-depth" (2.5, 12.5, and 22.5 only) into one panel

# Standardize the look of all plots
plots_list <- list(
  p_iphc12_rel + labs(title = "IPHC-12") + theme(legend.position = "none"),
  p_iphc13_rel + labs(title = "IPHC-13") + theme(legend.position = "none"),
  p_iphc15_rel + labs(title = "IPHC-15") + theme(legend.position = "none"),
  p_iphc22_rel + labs(title = "IPHC-22") + theme(legend.position = "none")
)

# Combine in a 2-column, 2-row layout with consistent axis formatting
combined_plot <- wrap_plots(plots_list, ncol = 2, guides = "collect") +
  plot_annotation(
    title = "Relative Species Abundance at Selected Sites",
    tag_levels = "A",
    tag_prefix = "",
    tag_suffix = ")"
  ) & 
  labs(y = "Relative\nabundance") &  # Two-line y-axis label here
  theme(
    plot.tag = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.position = "bottom"
  )

# Show it
combined_plot

ggsave("combined_plot_DER.png", combined_plot, width = 12, height = 10, dpi = 300)
```


#Huon (HUO)
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Filter dataframe for 'Faunal mid-depth' = 2.5
huo_filtered <- df_huon %>% filter(`Faunal mid-depth` == 2.5)

#Remove non-species columns (species columns start from the 5th column)
species_abundanceHUO <- huo_filtered[, 5:ncol(huo_filtered)]

#Convert dataframe to long format for plotting
species_abundanceHUO_long <- species_abundanceHUO %>%
  pivot_longer(cols = everything(), names_to = "Species", values_to = "Abundance")
View(species_abundanceHUO_long)

#Remove species with zero abundance
species_abundanceHUO_long <- species_abundanceHUO_long %>% filter(Abundance > 0)

#Order species by abundance
species_abundanceHUO_long <- species_abundanceHUO_long %>%
  arrange(desc(Abundance))

#Plot species abundance
pHUO <- ggplot(species_abundanceHUO_long, aes(x = reorder(Species, -Abundance), y = Abundance)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Huon Species abundance (mid-depth 2.5cm)",
       x = "Species",
       y = "Abundance")
pHUO
```

#Separate by "Site Code" for HUO (IPHC-31, IPHC-33) and "Faunal mid-depth" (2.5, 12.5, and 22.5 only):

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Define site code and depths of interest
Site_codes <- c("IPHC-31")
depths <- c(2.5, 12.5, 22.5)

# Filter data
der_filtered <- df_huon %>%
  filter(`Site Code` %in% Site_codes,
         `Faunal mid-depth` %in% depths)

# Convert to long format
species_abundance_long <- huo_filtered %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Put Species as factor so it doesn't auto-order globally
species_abundance_long$Species <- factor(species_abundance_long$Species)

# Plot with facetting
p_all_iphc31 <- ggplot(species_abundance_long, aes(x = Species, y = Abundance)) +
  geom_bar(stat = "identity") +
  facet_grid(`Site Code` ~ `Faunal mid-depth`, scales = "free_y") +
  #facet_wrap(~ `Site Code` + `Faunal mid-depth`, scales = "free_y", ncol = 3) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6),
    strip.text = element_text(size = 10),
    panel.spacing = unit(0.31, "lines"),
    axis.title.x = element_text(margin = margin(t = 10))
  ) +
  labs(title = "Species abundance by site and Faunal mid-depth",
       x = "Species",
       y = "Abundance")

p_all_iphc31
```

#Site 1/4 (HUO): IPHC-31 PETCHYS BAY
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for only Site Code IPHC-31 and depths of interest
df_iphc31 <- df_huon %>%
  filter(`Site Code` == "IPHC-31",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc31_long <- df_iphc31 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Make sure Species is a factor
iphc31_long$Species <- factor(iphc31_long$Species)

# Plot with custom fill colors
p_iphc31 <- ggplot(iphc31_long, aes(x = Species, y = Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#E6CCFF",  # light lavender
      "12.5" = "#A259FF", # medium vibrant purple
      "22.5" = "#4B0082"  # deep indigo
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Species abundance at IPHC-31 (by Faunal mid-depth)",
    x = "Species",
    y = "Abundance"
  )

p_iphc31
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-31 and relevant depths
df_iphc31 <- df_huon %>%
  filter(`Site Code` == "IPHC-31",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc31_long <- df_iphc31 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc31_relative <- iphc31_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc31_relative$Species <- factor(iphc31_relative$Species)

# Plot relative abundance
p_iphc31_rel <- ggplot(iphc31_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#E6CCFF",  # light lavender
      "12.5" = "#A259FF", # medium vibrant purple
      "22.5" = "#4B0082"  # deep indigo
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-31 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc31_rel #Loss of Nemocardium from 22.5cm (~545 ya) and Hiatella and Pecten fumatus from 12.5cm (~45 ya) to 2.5cm (~15 ya). Increase in Corbula and appearance of Theora in past ~45 years.
```

#Site 1/4 (HUO): IPHC-33 PORT CYGNET

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for IPHC-33 and relevant depths
df_iphc33 <- df_huon %>%
  filter(`Site Code` == "IPHC-33",
         `Faunal mid-depth` %in% c(2.5, 12.5, 22.5))

# Convert species columns to long format
iphc33_long <- df_iphc33 %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Species", values_to = "Abundance") %>%
  filter(Abundance > 0)

# Calculate relative abundance per depth
iphc33_relative <- iphc33_long %>%
  group_by(`Faunal mid-depth`) %>%
  mutate(Total_Abundance = sum(Abundance),
         Relative_Abundance = Abundance / Total_Abundance) %>%
  ungroup()

# Make Species a factor
iphc33_relative$Species <- factor(iphc33_relative$Species)

# Plot relative abundance
p_iphc33_rel <- ggplot(iphc33_relative, aes(x = Species, y = Relative_Abundance, fill = factor(`Faunal mid-depth`))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "2.5" = "#E6CCFF",  # light lavender
      "12.5" = "#A259FF", # medium vibrant purple
      "22.5" = "#4B0082"  # deep indigo
    ),
    name = "Faunal Mid-depth (cm)"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7),
    legend.position = "right"
  ) +
  labs(
    title = "Relative species abundance at IPHC-33 (by Faunal mid-depth)",
    x = "Species",
    y = "Relative Abundance"
  )

p_iphc33_rel #Loss of Nemocardium from 22.5cm (~545 ya) and Hiatella and Pecten fumatus from 12.5cm (~45 ya) to 2.5cm (~15 ya). Increase in Corbula and appearance of Theora in past ~45 years.
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Combine DCS plots for IPHC-31, IPHC-33 and "Faunal mid-depth" (2.5, 12.5, and 22.5 only) into one panel

# Standardize the look of all plots
plots_list <- list(
  p_iphc31_rel + labs(title = "IPHC-31") + theme(legend.position = "none"),
  p_iphc33_rel + labs(title = "IPHC-33") + theme(legend.position = "none")
)

# Combine in a 2-column, 3-row layout with consistent axis formatting
combined_plot <- wrap_plots(plots_list, ncol = 2, guides = "collect") +
  plot_annotation(
    title = "Relative Species Abundance at Selected Sites",
    tag_levels = "A",
    tag_prefix = "",
    tag_suffix = ")"
  ) & 
  labs(y = "Relative\nabundance") &  # Two-line y-axis label here
  theme(
    plot.tag = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.position = "bottom"
  )

# Show it
combined_plot

ggsave("combined_plot_HUO.png", combined_plot, width = 12, height = 10, dpi = 300)
```



#Code working from here onwards (19/5/25)...

#Total shell abundance and species richness

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Summarise total abundance and species richness per site and depth
summary_data <- dead_data %>%
  group_by(Site_location, Site_code, Mid_depth_cm) %>%
  summarise(
    Total_abundance = sum(Abundance),
    Species_richness = n_distinct(Species_name),
    .groups = "drop"
  )

summary_data

# Compute mean lines per location
location_means <- summary_data %>%
  group_by(Site_location, Mid_depth_cm) %>%
  summarise(
    Mean_abundance = mean(Total_abundance),
    Mean_richness = mean(Species_richness),
    .groups = "drop"
  )

# Get label positions (shallowest depth only)
site_labels_abund <- summary_data %>%
  dplyr::filter(Mid_depth_cm == min(Mid_depth_cm)) %>%
  dplyr::select(Site_location, Site_code, Mid_depth_cm, Total_abundance)

site_labels_rich <- summary_data %>%
  dplyr::filter(Mid_depth_cm == min(Mid_depth_cm)) %>%
  dplyr::select(Site_location, Site_code, Mid_depth_cm, Species_richness)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Plot 1: Abundance ###
plot_abundance <- ggplot() +
  geom_line(data = summary_data,
            aes(x = Mid_depth_cm, y = Total_abundance,
                group = Site_code, color = Site_location),
            linetype = "dotted") +
  geom_line(data = location_means,
            aes(x = Mid_depth_cm, y = Mean_abundance,
                group = Site_location, color = Site_location),
            size = 1) +
  geom_text_repel(data = site_labels_abund,
                  aes(x = Mid_depth_cm, y = Total_abundance, label = Site_code, color = Site_location),
                  size = 3, nudge_x = 1, direction = "y", hjust = 0, segment.color = NA) +
  facet_wrap(~ Site_location) +
  scale_color_manual(values = location_colors) +
  scale_x_reverse() +
  labs(
    x = "Mid-depth in core (cm)",
    y = "Total shell abundance",
    title = "A)"
  ) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Plot 2: Species Richness ###
plot_richness <- ggplot() +
  geom_line(data = summary_data,
            aes(x = Mid_depth_cm, y = Species_richness,
                group = Site_code, color = Site_location),
            linetype = "dotted") +
  geom_line(data = location_means,
            aes(x = Mid_depth_cm, y = Mean_richness,
                group = Site_location, color = Site_location),
            size = 1) +
  geom_text_repel(data = site_labels_rich,
                  aes(x = Mid_depth_cm, y = Species_richness, label = Site_code, color = Site_location),
                  size = 3, nudge_x = 1, direction = "y", hjust = 0, segment.color = NA) +
  facet_wrap(~ Site_location) +
  scale_color_manual(values = location_colors) +
  scale_x_reverse() +
  labs(
    x = "Mid-depth in core (cm)",
    y = "Species richness",
    title = "B)"
  ) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Combine with patchwork
combined_plot <- plot_abundance / plot_richness

# Print combined plot
print(combined_plot)

#ggsave("plot_abundrich_cores.png", combined_plot, width = 12, height = 10, dpi = 300)
```


#Data analysis:

#Generalised linear models (GLMM) to test whether dead abundance and species richness vary with Mid_depth_cm, Sieve_size_mm, Site_location, and Site_code, for count or non-normal data.
#Abundance (may require log or Poisson/negative binomial)
#Richness (count: Poisson or negative binomial)

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter dead data with abundance > 0
dead_data <- df %>%
  filter(Condition == "Dead", !is.na(Species_name), Abundance > 0)

# Summarise abundance and richness per sample unit
summary_data <- dead_data %>%
  group_by(Site_location, Site_code, Mid_depth_cm, Sieve_size_mm) %>%
  summarise(
    Total_abundance = sum(Abundance),
    Species_richness = n_distinct(Species_name),
    .groups = "drop"
  )

summary_data
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Poisson GLMM
mod_rich_pois <- glmmTMB(Species_richness ~ Mid_depth_cm * Sieve_size_mm * Site_location +
                           (1 | Site_code),
                         data = summary_data,
                         family = poisson())

# Check overdispersion
check_overdispersion(mod_rich_pois) #no overdispersion detected

summary(mod_rich_pois)

# # Try Negative Binomial if overdispersed
# mod_rich_nb <- glmmTMB(Species_richness ~ Mid_depth_cm * Sieve_size_mm * Site_location +
#                          (1 | Site_code),
#                        data = summary_data,
#                        family = nbinom2())

# summary(mod_rich_pois)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
mod_abund <- glmmTMB(Total_abundance ~ Mid_depth_cm * Sieve_size_mm * Site_location +
                       (1 | Site_code),
                     data = summary_data,
                     family = nbinom2())

summary(mod_abund)
```





#2. COMBINE CATH'S OLD CORE DATA WITH NEW CORE DATA TO COMPARE SPECIES RICHNESS AND ABUNDANCE BETWEEN OVERLAPPING LAYERS

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#OLD DATA (2000/2001)

#Re-arrange Cath's data from wide to long format
sabund <- read_csv("Data/Allsites_sabund.csv")
str(sabund)

# Reshape to long format, ensuring all value columns are treated the same
sabund_long <- sabund %>%
  pivot_longer(
    cols = -c(`Site Code`, `Faunal mid-depth.x`),
    names_to = "Species name",
    values_to = "Abundance",
    values_transform = list(Abundance = as.numeric)  # Convert everything to numeric
  )

# View the result
View(sabund_long)

# Remove ".x" from the end of species names
sabund_long <- sabund_long %>%
  mutate(`Species name` = str_remove(`Species name`, "\\.x$"))
str(sabund_long)

#Save csv file for export
write.csv(sabund_long, "Data/olddata_sabund_long.csv")

# Count unique species total
n_unique_species <- sabund_long %>%
  filter(!is.na(`Species name`)) %>%
  summarise(Unique_species = n_distinct(`Species name`))

# View the result
n_unique_species #298

# Count unique species per depth at each site
species_richness_site_depth <- sabund_long %>%
  filter(!is.na(`Species name`), Abundance > 0) %>%
  group_by(`Site Code`, `Faunal mid-depth.x`) %>%
  summarise(Species_richness = n_distinct(`Species name`), .groups = "drop")

# View results
head(species_richness_site_depth)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Plot 1: Abundance ###
plot_abundance <- ggplot() +
  geom_line(data = sabund_long,
            aes(x = Faunal mid-depth.x, y = Abundance,
                group = Site Code),
            linetype = "dotted") +
  geom_line(data = location_means,
            aes(x = Mid_depth_cm, y = Mean_abundance,
                group = Site_location),
            size = 1) +
  geom_text_repel(data = site_labels_abund,
                  aes(x = Faunal mid-depth.x, y = Abundance, label = Site Code),
                  size = 3, nudge_x = 1, direction = "y", hjust = 0, segment.color = NA) +
  #facet_wrap(~ Site_location) +
  #scale_color_manual(values = location_colors) +
  scale_x_reverse() +
  labs(
    x = "Mid-depth in core (cm) OLD DATA",
    y = "Total shell abundance",
    title = "A)"
  ) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Plot 2: Species Richness ###
plot_richness <- ggplot() +
  geom_line(data = summary_data,
            aes(x = Mid_depth_cm, y = Species_richness,
                group = Site_code, color = Site_location),
            linetype = "dotted") +
  geom_line(data = location_means,
            aes(x = Mid_depth_cm, y = Mean_richness,
                group = Site_location, color = Site_location),
            size = 1) +
  geom_text_repel(data = site_labels_rich,
                  aes(x = Mid_depth_cm, y = Species_richness, label = Site_code, color = Site_location),
                  size = 3, nudge_x = 1, direction = "y", hjust = 0, segment.color = NA) +
  facet_wrap(~ Site_location) +
  scale_color_manual(values = location_colors) +
  scale_x_reverse() +
  labs(
    x = "Mid-depth in core (cm)",
    y = "Species richness",
    title = "B)"
  ) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
### Combine with patchwork
combined_plot <- plot_abundance / plot_richness

# Print combined plot
print(combined_plot)

#ggsave("plot_abundrich_cores.png", combined_plot, width = 12, height = 10, dpi = 300)
```


#3. LIVE-DEAD ASSEMBLAGE ANALYSIS

#Compare live species in 2024 VV grab samples with dead species in old 
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#OLD CORE DATA: Subset data to 2.5mm mid-depth only (up to 8 - 24 years old) and get unique species names
#Filter for depth = 2.5 cm
sabund_2.5 <- sabund_long %>%
  filter(`Faunal mid-depth.x` == 2.5)

#Clean species names (remove ".x" if present)
sabund_2.5 <- sabund_2.5 %>%
  mutate(`Species name` = str_remove(`Species name`, "\\.x$"))

#Get unique species names
unique_species_2.5 <- sabund_2.5 %>%
  filter(!is.na(`Species name`)) %>%
  distinct(`Species name`) %>%
  arrange(`Species name`)

#Write to csv file
write_csv(unique_species_2.5, "Data/olddata_unique_species_depth_2.5.csv")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#NEW VV GRAB DATA: Get unique species names
file_livedead <- 'Data/Data_entry_SETas2024-VV_grab.csv'

#Read csv file into dataframe
df_livedead <- read.csv(file_livedead, stringsAsFactors = FALSE, check.names = FALSE)
str(df_livedead)
#View(df_livedead)

#Get unique species names
unique_species_df_livedead <- df_livedead %>%
  filter(!is.na(`Species_name`)) %>%
  distinct(`Species_name`) %>%
  arrange(`Species_name`)

#Write to csv file
write_csv(unique_species_df_livedead, "Data/newdata_unique_species_df_livedead.csv")

#Check which species names are present in new VV grab data (unique_species_df_livedead) but not in the old core data (unique_species_2.5)
species_only_in_livedead <- unique_species_df_livedead %>%
  filter(!Species_name %in% unique_species_2.5$`Species name`)

# View the result
print(species_only_in_livedead)

# (Optional) Save to CSV
write.csv(species_only_in_livedead, "Data/species_only_in_livedead.csv", row.names = FALSE)

#Replace the following species names in sabund_2.5 with names that match df_livedead:
# Dentimitrella sp --> Anachis atkinsoni
# Lepsiella vinosa (check) --> Bedeva paivae
# Bittium granarium or Bittium granarium.y --> Cacozeliana granarium
# Cardita excavata or Cardita excavata.y or Cardita sp? --> Cardita aviculina
# Thyasira adelaideana or Thyasira adelaideana (fragments?) or Thyasira adelaideana.y --> Channelaxinus adelaideanus
# Corbula (Varicorbula) gibba or Corbula (Varicorbula) gibba.y --> Corbula gibba
# Leionucula obliqua or Leionucula obliqua.y or Leionucula sp or Nucula coura? or Nucula sp or Nucula sp A --> Ennucula obliqua
# Gari (Gari) livida --> Gari livida
# Guraleus alucinans or Guraleus alucinans.y or Guraleus sp --> Guraleus sp.1
# Irus (Irus) carditoides or Venerupis (Venerupis) anomala or Venerupis anomala or Venerupis anomala.y or Venerupis largillierti or Venerupis largillierti.y --> Irus cf. carditoides
# Crassostrea gigas --> Magallana gigas 
# Musculus sp or Musculus sp_ or Musculus sp_.y --> Musculus impactus
# Myadora brevis or Myadora sp_ or Myadora sp_.y --> Myadora albida
# Mussels --> Mytilus galloprovincialis
# Ostrea angasi or Ostrea angasi.y --> Ostrea (Eostrea) angasi
# Phasianotrochus rutilus or Phasianotrochus rutilus.y --> Phasianotrochus irisodontes
# Philine angasi or Philine angasi.y or Philine sp or retusa sp? or Philine sp or retusa sp?.y --> Philine sp.3
# Cuspidaria brazieri  (check) or Cuspidaria brazieri  (check).y --> Plectodon brazieri
# Nemocardium (Pratulum) thetidis or Nemocardium (Pratulum) thetidis.y --> Pratulum thetidis
# Fusinus novohollandiae or Fusinus novohollandiae.y --> Propefusus novaehollandiae 
# Cardita excavata or Cardita excavata.y or Cardita sp? --> Purpurocardia bimaculata
# Retusa sp_ or Retusa sp_ 2 or Retusa sp_.y --> Retusa atkinsoni
# Tawera gallinulla --> Tawera gallinula
# Thracia cf myodoroides or Thracia cf myodoroides.y --> Thracia sp.38
# Timoclea (Chioneryx) cardioides or Timoclea (Chioneryx) cardioides.y --> Timoclea sp.4

#Species with no matches between datasets:
# Galeommatid sp.22
# Limaria imitans
# Neotrigonia margaritacea
# Notoacmea flammea
# Propilidium tasmanicum
# Pyramidellid sp.11
# Splendrillia woodsi
# Sypharochiton pelliserpentis
# Trochid sp.3
# Turbonilla sp.
# Ungulinid sp.20

sabund_2.5 <- sabund_2.5 %>%
  mutate(`Species name` = str_trim(`Species name`),  # remove leading/trailing whitespace
         `Species name` = case_when(
           
           `Species name` == "Dentimitrella sp" ~ "Anachis atkinsoni",
           str_detect(`Species name`, "Lepsiella vinosa") ~ "Bedeva paivae",
           `Species name` %in% c("Bittium granarium", "Bittium granarium.y") ~ "Cacozeliana granarium",
           `Species name` %in% c("Cardita excavata", "Cardita excavata.y", "Cardita sp?") ~ "Cardita aviculina",
           `Species name` %in% c("Thyasira adelaideana", "Thyasira adelaideana (fragments?)", "Thyasira adelaideana.y") ~ "Channelaxinus adelaideanus",
           `Species name` %in% c("Corbula (Varicorbula) gibba", "Corbula (Varicorbula) gibba.y") ~ "Corbula gibba",
           `Species name` %in% c("Leionucula obliqua", "Leionucula obliqua.y", "Leionucula sp", "Nucula coura?", "Nucula sp", "Nucula sp A") ~ "Ennucula obliqua",
           `Species name` == "Gari (Gari) livida" ~ "Gari livida",
           `Species name` %in% c("Guraleus alucinans", "Guraleus alucinans.y", "Guraleus sp") ~ "Guraleus sp.1",
           `Species name` %in% c("Irus (Irus) carditoides", "Venerupis (Venerupis) anomala", "Venerupis anomala", "Venerupis anomala.y", 
                                 "Venerupis largillierti", "Venerupis largillierti.y") ~ "Irus cf. carditoides",
           `Species name` == "Crassostrea gigas" ~ "Magallana gigas",
           `Species name` %in% c("Musculus sp", "Musculus sp_", "Musculus sp_.y") ~ "Musculus impactus",
           `Species name` %in% c("Myadora brevis", "Myadora sp_", "Myadora sp_.y") ~ "Myadora albida",
           `Species name` == "Mussels" ~ "Mytilus galloprovincialis",
           `Species name` %in% c("Ostrea angasi", "Ostrea angasi.y") ~ "Ostrea (Eostrea) angasi",
           `Species name` %in% c("Phasianotrochus rutilus", "Phasianotrochus rutilus.y") ~ "Phasianotrochus irisodontes",
           `Species name` %in% c("Philine angasi", "Philine angasi.y", "Philine sp", "retusa sp?", "retusa sp?.y") ~ "Philine sp.3",
           `Species name` %in% c("Cuspidaria brazieri  (check)", "Cuspidaria brazieri  (check).y") ~ "Plectodon brazieri",
           `Species name` %in% c("Nemocardium (Pratulum) thetidis", "Nemocardium (Pratulum) thetidis.y") ~ "Pratulum thetidis",
           `Species name` %in% c("Fusinus novohollandiae", "Fusinus novohollandiae.y") ~ "Propefusus novaehollandiae",
           `Species name` %in% c("Cardita excavata", "Cardita excavata.y", "Cardita sp?") ~ "Purpurocardia bimaculata",
           `Species name` %in% c("Retusa sp_", "Retusa sp_ 2", "Retusa sp_.y") ~ "Retusa atkinsoni",
           `Species name` == "Tawera gallinulla" ~ "Tawera gallinula",
           `Species name` %in% c("Thracia cf myodoroides", "Thracia cf myodoroides.y") ~ "Thracia sp.38",
           `Species name` %in% c("Timoclea (Chioneryx) cardioides", "Timoclea (Chioneryx) cardioides.y") ~ "Timoclea sp.4",
           
           TRUE ~ `Species name`  # keep original name if no match
         ))

#Remove ".y" after some species names
sabund_2.5 <- sabund_2.5 %>%
  mutate(`Species name` = str_remove(`Species name`, "\\.y$"))
View(sabund_2.5)

#Get unique species names
unique_species_2.5 <- sabund_2.5 %>%
  filter(!is.na(`Species name`)) %>%
  distinct(`Species name`) %>%
  arrange(`Species name`)
View(unique_species_2.5)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Merge OLD and NEW core data into VV grab data to analyse live-dead assemblages
#note: species names in OLD data (sabund_2.5) fixed to match with new 2024 data wherever possible

#Locate files
data_files_paths <- file.path("data/", list.files("data/"))
list.files("data/") 
```
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#Load csv files
file_livedead <- 'Data/Data_entry_SETas2024-VV_grab.csv'

#Read csv file into dataframe
df_livedead <- read.csv(file_livedead, stringsAsFactors = FALSE, check.names = FALSE)
str(df_livedead)
View(df_livedead)
```
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Summarise live abundances in VV grab samples across replicates and sieve sizes
df_livedead_summary <- df_livedead %>%
  filter(Condition == "Live") %>%
  group_by(Site_code, Species_name) %>%
  summarise(Total_live_abundance = sum(Abundance, na.rm = TRUE), .groups = "drop")

# View result
print(df_livedead_summary)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Merge Abundance column from sabund (OLD DATA) and df_livedead_summary

#Standardize Site Code in sabund_2.5
sabund_2.5_clean <- sabund_2.5 %>%
  mutate(Site_code = str_replace_all(`Site Code`, "[-\\s]", ""))  # Remove dashes and spaces

#Standardize Species name in both datasets (optional but good practice)
sabund_2.5_clean <- sabund_2.5_clean %>%
  mutate(Species_name = str_trim(`Species name`))

df_livedead_summary_clean <- df_livedead_summary %>%
  mutate(Species_name = str_trim(Species_name))

#Merge datasets on Site_code and Species_name
merged_abundance <- left_join(
  sabund_2.5_clean,
  df_livedead_summary_clean,
  by = c("Site_code", "Species_name")
)

# View result
print(merged_abundance)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Merge dead abundances (NEW DATA) from dead_data with merged_abundance dataset

#Read in the dead data
dead_data <- read_csv("Data/Data_entry_SETas2024-Cores.csv")

#Filter for dead specimens at 2.5 cm
dead_data_2.5 <- dead_data %>%
  filter(Mid_depth_cm == 2.5, Condition == "Dead")

#Summarise total dead abundance per Site_code and Species_name
dead_summary <- dead_data_2.5 %>%
  group_by(Site_code, Species_name) %>%
  summarise(Dead_abundance = sum(Abundance, na.rm = TRUE), .groups = "drop")

#Standardise Site_code and Species_name for joining
dead_summary <- dead_summary %>%
  mutate(
    Site_code = str_replace_all(Site_code, "[-\\s]", ""),
    Species_name = str_trim(Species_name)
  )

#Standardise the same fields in merged_abundance
merged_abundance_clean <- merged_abundance %>%
  mutate(
    Site_code = str_replace_all(Site_code, "[-\\s]", ""),
    Species_name = str_trim(Species_name)
  )

#Merge with dead abundance data
final_merged <- left_join(
  merged_abundance_clean,
  dead_summary,
  by = c("Site_code", "Species_name")
)

names(final_merged)

final_merged <- final_merged %>%
  rename(
    Old_core_data_Dead_abundance = Abundance,
    New_VV_grab_data_Live_abundance = Total_live_abundance,
    New_core_data_Dead_abundance = Dead_abundance
  )

# View final result
print(final_merged)
View(final_merged)

# Optional: write to file
write_csv(final_merged, "Merged_Abundance_Live_Dead_Summarised.csv")
```

#3a. LIVE (VAN VEEN GRAB SAMPLES) VS. 1. OLD CORE DEAD and 2. NEW CORE DEAD: LIVE-DEAD DISCORDANCE ANALYSIS
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
final_merged <- final_merged %>%
  rename(
    Live_abundance = New_VV_grab_data_Live_abundance,
    Dead_abundance_old = Old_core_data_Dead_abundance,
    Dead_abundance_new = New_core_data_Dead_abundance
  )
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Ensure the data frame is being passed in correctly
run_discordance <- function(data, live_col, dead_col, title) {
  # Select only relevant columns, and rename for clarity
  df <- data %>%
    dplyr::select(
      Site_code,
      Species_name,
      Live = !!sym(live_col),
      Dead = !!sym(dead_col)
    ) %>%
    filter(!is.na(Live) | !is.na(Dead))  # Drop rows where both are NA

  # Pivot wider to have separate Site_code x Species_name rows
  df_long <- df %>%
    tidyr::pivot_longer(cols = c(Live, Dead), names_to = "Condition", values_to = "Abundance") %>%
    dplyr::filter(Abundance > 0)

  # Optional: plot or summarise
  print(ggplot2::ggplot(df_long, aes(x = Condition, y = Abundance)) +
    geom_boxplot() +
    facet_wrap(~Site_code) +
    ggtitle(title))

  # Return long-form data for optional further analysis
  return(df_long)
}
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
colnames(final_merged)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
comparison1 <- run_discordance(
  data = final_merged,
  live_col = "Live_abundance",
  dead_col = "Dead_abundance_old",
  title = "Live vs Old Core Dead Assemblage (2.5 cm)"
)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
final_merged %>%
  filter(
    !is.na(Live_abundance) & Live_abundance > 0 &
    !is.na(Dead_abundance_old) & Dead_abundance_old > 0
  ) %>%
  group_by(Site_code) %>%
  summarise(n_shared_species = n()) %>%
  arrange(desc(n_shared_species))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
overlapping_data <- final_merged %>%
  filter(!is.na(Live_abundance) & Live_abundance > 0,
         !is.na(Dead_abundance_old) & Dead_abundance_old > 0)

ld_long <- overlapping_data %>%
  dplyr::select(Site_code, Species_name, 
         Live = Live_abundance, 
         Dead = Dead_abundance_old) %>%
  pivot_longer(cols = c(Live, Dead), names_to = "Condition", values_to = "Abundance") %>%
  group_by(Site_code, Condition, Species_name) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

ld_comm <- ld_long %>%
  pivot_wider(names_from = Species_name, values_from = Abundance, values_fill = 0)

metadata <- ld_comm %>% dplyr::select(Site_code, Condition)
species_matrix <- ld_comm %>% dplyr::select(-Site_code, -Condition)

# Add rownames for vegan functions
rownames(species_matrix) <- paste(metadata$Site_code, metadata$Condition, sep = "_")

# Bray-Curtis dissimilarity
bray_dist <- vegdist(species_matrix, method = "bray")

adonis_result <- adonis2(species_matrix ~ Condition, data = metadata, method = "bray")
print(adonis_result)

anosim_result <- anosim(species_matrix, grouping = metadata$Condition, distance = "bray")
print(anosim_result)


# There is a statistically significant difference in species composition between the live assemblages and the dead assemblages from the old core samples at 2.5 cm depth:
# 
#     p = 0.019 means this result is unlikely due to chance under the null hypothesis (i.e. that live and dead assemblages are not different).
# 
#     The R² of 0.30 shows a moderate effect size — the Condition explains ~30% of variation in community structure.
# 
#     This suggests ecological filtering or taphonomic bias between what is alive now vs. what is preserved in the death assemblage.

# A PERMANOVA based on Bray-Curtis dissimilarity revealed a significant difference in species composition between live and dead (old core) assemblages at 2.5 cm depth (F₁,₈ = 3.46, R² = 0.30, p = 0.019). This indicates moderate live-dead discordance in community structure, with approximately 30% of variation explained by condition.
```

#New cores

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
comparison2 <- run_discordance(
  data = final_merged,
  live_col = "Live_abundance",
  dead_col = "Dead_abundance_new",
  title = "Live vs New Core Dead Assemblage (2.5 cm)"
)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
final_merged %>%
  filter(
    !is.na(Live_abundance) & Live_abundance > 0 &
    !is.na(Dead_abundance_new) & Dead_abundance_new > 0
  ) %>%
  group_by(Site_code) %>%
  summarise(n_shared_species = n()) %>%
  arrange(desc(n_shared_species))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
overlapping_data <- final_merged %>%
  filter(!is.na(Live_abundance) & Live_abundance > 0,
         !is.na(Dead_abundance_new) & Dead_abundance_new > 0)

ld_long <- overlapping_data %>%
  dplyr::select(Site_code, Species_name, 
         Live = Live_abundance, 
         Dead = Dead_abundance_new) %>%
  pivot_longer(cols = c(Live, Dead), names_to = "Condition", values_to = "Abundance") %>%
  group_by(Site_code, Condition, Species_name) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

ld_comm <- ld_long %>%
  pivot_wider(names_from = Species_name, values_from = Abundance, values_fill = 0)

metadata <- ld_comm %>% dplyr::select(Site_code, Condition)
species_matrix <- ld_comm %>% dplyr::select(-Site_code, -Condition)

# Add rownames for vegan functions
rownames(species_matrix) <- paste(metadata$Site_code, metadata$Condition, sep = "_")

# Bray-Curtis dissimilarity
bray_dist <- vegdist(species_matrix, method = "bray")

adonis_result <- adonis2(species_matrix ~ Condition, data = metadata, method = "bray")
print(adonis_result)

anosim_result <- anosim(species_matrix, grouping = metadata$Condition, distance = "bray")
print(anosim_result)

# There is no significant difference between the live assemblages and the new core dead assemblages at 2.5 cm depth:
# 
# p = 0.407 indicates that observed differences in community composition between live and dead samples are likely due to chance.
# 
# The R² = 0.12 reflects a small effect size — only ~12% of variation in species composition is attributable to condition (live vs dead).
# 
# This suggests the new core dead assemblage is more similar to the live community than the old core was, possibly indicating:
# 
# Better preservation or sampling match
# 
# Less taphonomic bias
# 
# Less time averaging

# In contrast, a PERMANOVA comparing live assemblages to dead assemblages from the new core showed no significant difference (F₁,₈ = 1.07, R² = 0.12, p = 0.407), indicating limited compositional divergence between live and newly deposited death assemblages at 2.5 cm.
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
library(dplyr)
library(tidyr)
library(vegan)

run_nmds <- function(data, live_col, dead_col) {
  # Step 1: Long format
  df_long <- data %>%
    dplyr::select(Site_code, Species_name,
                  Live = !!sym(live_col),
                  Dead = !!sym(dead_col)) %>%
    pivot_longer(cols = c(Live, Dead), names_to = "Condition", values_to = "Abundance") %>%
    filter(!is.na(Abundance), Abundance > 0) %>%
    group_by(Site_code, Condition, Species_name) %>%
    summarise(Abundance = sum(Abundance), .groups = "drop")

  # Step 2: Community matrix
  comm_matrix <- df_long %>%
    pivot_wider(names_from = Species_name,
                values_from = Abundance,
                values_fill = list(Abundance = 0)) %>%
    mutate(Site_ID = paste(Site_code, Condition, sep = "_"))  # unique ID

  # Step 3: Separate metadata and species data
  metadata <- comm_matrix %>% dplyr::select(Site_ID, Site_code, Condition)
  species_data <- comm_matrix %>% dplyr::select(-Site_code, -Condition, -Site_ID)

  # Step 4: Remove rows with all-zero abundance
  keep <- rowSums(species_data) > 0
  metadata_filtered <- metadata[keep, ]
  species_data_filtered <- species_data[keep, ]

  # Step 5: Run NMDS
  nmds <- metaMDS(species_data_filtered, distance = "bray", k = 2, trymax = 100)

  # Step 6: Get scores and join to metadata
  scores_df <- as.data.frame(scores(nmds))
  scores_df$Site_ID <- rownames(scores_df)
  output <- left_join(scores_df, metadata_filtered, by = "Site_ID")

  return(list(scores = output, stress = nmds$stress))
}
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Run NMDS for live vs old core dead
nmds_old <- run_nmds(final_merged, "Live_abundance", "Dead_abundance_old")

# Run NMDS for live vs new core dead
nmds_new <- run_nmds(final_merged, "Live_abundance", "Dead_abundance_new")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
species_by_site <- final_merged %>%
  group_by(Site_code) %>%
  summarise(
    Live_species = n_distinct(Species_name[Live_abundance > 0], na.rm = TRUE),
    Dead_new_species = n_distinct(Species_name[Dead_abundance_new > 0], na.rm = TRUE),
    Dead_old_species = n_distinct(Species_name[Dead_abundance_old > 0], na.rm = TRUE)
  )

print(species_by_site)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Convert to long format for plotting
species_long <- species_by_site %>%
  pivot_longer(cols = c(Live_species, Dead_new_species, Dead_old_species),
               names_to = "Condition",
               values_to = "Richness")

ggplot(species_long, aes(x = Site_code, y = Richness, fill = Condition)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7)) +
  scale_fill_manual(values = c(
    Live_species = "darkgreen",        # Blue for live
    Dead_new_species = "red",    # Purple for new dead
    Dead_old_species = "darkred"     # Orange for old dead
  )) +
  labs(
    title = "Species Richness per Site",
    x = "Site Code",
    y = "Number of Species (Abundance > 0)",
    fill = "Condition"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}

```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}

```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}

```


#3b. LIVE VS. DEAD (VAN VEEN GRAB SAMPLES): LIVE-DEAD DISCORDANCE ANALYSIS
```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
library(ggplot2)
library(patchwork)

plot_old <- ggplot(nmds_old$scores, aes(NMDS1, NMDS2, color = Site_code, shape = Condition)) +
  geom_point(size = 3) +
  geom_path(aes(group = Site_code), linetype = "dashed", alpha = 0.5) +
  theme_minimal() +
  labs(title = "A) Live vs Old Core Dead",
       subtitle = paste("Stress =", round(nmds_old$stress, 3)))

plot_new <- ggplot(nmds_new$scores, aes(NMDS1, NMDS2, color = Site_code, shape = Condition)) +
  geom_point(size = 3) +
  geom_path(aes(group = Site_code), linetype = "dashed", alpha = 0.5) +
  theme_minimal() +
  labs(title = "B) Live vs New Core Dead",
       subtitle = paste("Stress =", round(nmds_new$stress, 3)))

combined_plot <- plot_old + plot_new +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")

print(combined_plot)

```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}


```




#3c. VAN VEEN GRAB SAMPLES: LIVE-DEAD DISCORDANCE ANALYSIS

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
#Locate files
data_files_paths <- file.path("data/", list.files("data/"))
list.files("data/") 
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#Load csv files
file_livedead <- 'Data/Data_entry_SETas2024-VV_grab.csv'

#Read csv file into dataframe
df_livedead <- read.csv(file_livedead, stringsAsFactors = FALSE, check.names = FALSE)
str(df_livedead)
View(df_livedead)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Summarise total abundance
abundance_summary <- df_livedead %>%
  group_by(Site_location, Site_code, Sieve_size_mm, Condition, Species_name) %>%
  summarise(Total_abundance = sum(Abundance, na.rm = TRUE), .groups = "drop") %>%
  arrange(Site_location, Site_code, Sieve_size_mm, Condition, Species_name)

# View the result
head(abundance_summary)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Plot
ggplot(abundance_summary, aes(x = Site_code, y = Total_abundance, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Live" = "#8FBC8F", "Dead" = "#CD5C5C")) +
  labs(title = "Live vs Dead Abundance by Site",
       x = "Site Code",
       y = "Total Abundance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Plot
ggplot(abundance_summary, aes(x = Species_name, y = Total_abundance, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Live" = "#8FBC8F", "Dead" = "#CD5C5C")) +
  labs(title = "Live vs Dead Abundance by Species",
       x = "Species",
       y = "Total Abundance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = TRUE}
# Filter for 2.8mm sieve size
abundance_summary2.8mm <- abundance_summary %>%
  filter(`Sieve_size_mm` == "2.8")

ggplot(abundance_summary2.8mm, aes(x = Species_name, y = Total_abundance, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Live" = "#8FBC8F", "Dead" = "#CD5C5C")) +
  labs(title = "Live vs Dead Abundance by Species (2.8mm sieve)",
       x = "Species",
       y = "Total Abundance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# Read in your dataset
df <- read_csv("Data/Data_entry_SETas2024-VV_grab.csv")

# Inspect structure
glimpse(df)

# Ensure key columns are factors
df <- df %>%
  mutate(across(c(Site_code, Site_location, Sieve_size_mm, Replicate, Condition, Species_code), as.factor))

# Pivot to wide form: one row per Replicate per group, one column per species
comm_data <- df %>%
  group_by(Site_code, Site_location, Sieve_size_mm, Replicate, Condition, Species_code) %>%
  summarise(abundance = sum(Abundance), .groups = "drop") %>%
  pivot_wider(names_from = Species_code, values_from = abundance, values_fill = 0)

# Create a unique ID for grouping
comm_data <- comm_data %>%
  unite("group_id", Site_code, Site_location, Sieve_size_mm, Replicate, remove = FALSE)

# Split into live and dead matrices
live_matrix <- comm_data %>% filter(Condition == "Live")
dead_matrix <- comm_data %>% filter(Condition == "Dead")

# Ensure same row order for paired comparisons
live_matrix <- live_matrix %>% arrange(group_id)
dead_matrix <- dead_matrix %>% arrange(group_id)

# Keep only the species columns
species_cols <- setdiff(names(live_matrix), c("Site_code", "Site_location", "Sieve_size_mm", "Replicate", "Condition", "group_id"))
live_species <- live_matrix[, species_cols]
dead_species <- dead_matrix[, species_cols]

# Compute live-dead dissimilarity (Bray-Curtis) for each Replicate
discordance <- vegan::vegdist(rbind(live_species, dead_species), method = "bray")
n <- nrow(live_species)
discordance_values <- diag(as.matrix(discordance)[1:n, (n+1):(2*n)])

# Combine metadata with results
results_df <- live_matrix %>%
  dplyr::select(Site_code, Site_location, Sieve_size_mm, Replicate, group_id) %>%
  mutate(live_dead_dissimilarity = discordance_values)

```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📊 Visualisations
# ─────────────────────────────────────────────────────

# Boxplot by Site_code
ggplot(results_df, aes(x = Site_code, y = live_dead_dissimilarity)) +
  geom_boxplot() +
  labs(title = "Live-Dead Dissimilarity by Site", y = "Bray-Curtis Dissimilarity")

# Boxplot by Site_location
ggplot(results_df, aes(x = Site_location, y = live_dead_dissimilarity)) +
  geom_boxplot() +
  labs(title = "Live-Dead Dissimilarity by Location", y = "Bray-Curtis Dissimilarity")

# Boxplot by sieve size
ggplot(results_df, aes(x = as.factor(Sieve_size_mm), y = live_dead_dissimilarity)) +
  geom_boxplot() +
  labs(title = "Live-Dead Dissimilarity by Sieve Size", x = "Sieve Size (mm)", y = "Bray-Curtis Dissimilarity")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📈 Test effects with linear mixed effects models
# ─────────────────────────────────────────────────────

# Linear mixed model (Replicates are nested within sites)

#Fixed effects: test whether Site_code or sieve size significantly affect discordance.
#Random effects: account for non-independence due to repeated measures within sites and among replicates.
#Model overfitted so Site_location removed (plots seem to show no differences among locations)

# Ensure Replicate is a factor
results_df <- results_df %>%
  mutate(across(c(Site_code, Replicate, Sieve_size_mm), as.factor))

# Fit the mixed model
lmm <- lmer(live_dead_dissimilarity ~ Sieve_size_mm + Site_location +
              (1 | Site_code/Replicate),
            data = results_df)

# View results with p-values
summary(lmm)
#Sig effect of sieve size on discordance. No sig effect of site or site location

# Marginal means for sieve size
emmeans(lmm, pairwise ~ Sieve_size_mm)
#2.8mm discordance sig > 1mm and 1.4mm
#4mm discordance sig > 1mm and 1.4mm

# Marginal means for Site_code
emmeans(lmm, pairwise ~ Site_code)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📊 Visualisations
# ─────────────────────────────────────────────────────
# Predicted values
pred_sieve <- ggpredict(lmm, terms = "Sieve_size_mm")  # uses levels as factor
pred_location <- ggpredict(lmm, terms = "Site_location")

# Convert sieve size to numeric for color gradient
results_df$sieve_size_mm_num <- as.numeric(as.character(results_df$Sieve_size_mm))

# For sieve size
emm_sieve <- emmeans(lmm, ~ Sieve_size_mm)
cld_sieve <- cld(emm_sieve, Letters = letters, adjust = "tukey")

# For site location
emm_location <- emmeans(lmm, ~ Site_location)
cld_location <- cld(emm_location, Letters = letters, adjust = "tukey")

# Find max predicted value for each plot
max_y_sieve <- max(pred_sieve$conf.high, na.rm = TRUE)
max_y_location <- max(pred_location$conf.high, na.rm = TRUE)

# Add y position columns to group data
cld_sieve$y_pos <- max_y_sieve + 0.1
cld_location$y_pos <- max_y_location + 0.2
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# --- PLOT 1: Sieve size panel with group letters ---
plot_sieve <- ggplot(results_df, aes(x = Sieve_size_mm, y = live_dead_dissimilarity)) +
  annotate("text", x = -Inf, y = Inf, label = "A)", hjust = -0.2, vjust = 1.5, size = 6, fontface = "bold") +
  geom_boxplot(outlier.shape = NA, fill = "grey90", color = "black", linewidth = 1) +
  geom_jitter(aes(color = sieve_size_mm_num),
              width = 0.2, size = 3, alpha = 0.8) +
  geom_text(data = cld_sieve,
            aes(x = Sieve_size_mm, y = y_pos, label = .group),
            color = "black", size = 5, inherit.aes = FALSE) +
  scale_color_gradient(low = "#a8e6a3", high = "#006400") +
  labs(title = "Live-dead dissimilarity by sieve size",
       x = "Sieve Size (mm)", y = "Bray-Curtis Dissimilarity") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# --- PLOT 2: Site location panel with group letters ---
plot_location <- ggplot(results_df, aes(x = Site_location, y = live_dead_dissimilarity)) +
  annotate("text", x = -Inf, y = Inf, label = "B)", hjust = -0.2, vjust = 1.5, size = 6, fontface = "bold") +
  geom_boxplot(outlier.shape = NA, fill = "grey90", color = "black", linewidth = 1) +
  geom_jitter(aes(color = Site_location),
              width = 0.2, size = 3, alpha = 0.8) +
  geom_text(data = cld_location,
            aes(x = Site_location, y = y_pos, label = .group),
            color = "black", size = 5, inherit.aes = FALSE) +
  scale_color_manual(values = site_colors) +
  labs(title = "Live-dead dissimilarity by site location",
       x = "Site Location", y = "Bray-Curtis Dissimilarity") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
plot_predlivedead <- plot_sieve + plot_location
plot_predlivedead
ggsave("plot_predlivedead.png", plot_predlivedead, width = 12, height = 10, dpi = 300)
```

#All sieve sizes and replicates combined:

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📈 Test effects with ANOVA
# ─────────────────────────────────────────────────────

# ANOVA
#Fixed effects: test whether Site_code and Site_location significantly affect discordance independently of sieve size.

# Run the ANOVA
anova_model <- aov(live_dead_dissimilarity ~ Site_location + Site_code, data = results_df)

# ANOVA summary
summary(anova_model)
#Sig effect of Site_location on discordance. No sig effect of Site_code

# Estimated marginal means for Site_location
emm_location <- emmeans(anova_model, ~ Site_location)

# Pairwise comparisons with Tukey adjustment
pairwise_location <- contrast(emm_location, method = "pairwise", adjust = "tukey")

# View results
summary(pairwise_location)

# Compact letter display for plotting group differences
cld_location <- cld(emm_location, Letters = letters, adjust = "tukey")

# View group letters
print(cld_location)

```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
# ─────────────────────────────────────────────────────
# 📊 Visualisations
# ─────────────────────────────────────────────────────

# Define colors for Site_location
site_colors <- c("DEntrecasteaux" = "#FFA500",
                 "Derwent" = "#1E90FF",
                 "Huon" = "#A259FF")

# Desired order of Site_code
site_order <- c("IPHC10", "IPHC28", "IPHC15", "IPHC25", "IPHC31", "IPHC33")
# Apply order to the data frame
results_df$Site_code <- factor(results_df$Site_code, levels = site_order)


# Boxplot by Site_code (Panel 1)
plot_site <- ggplot(results_df, aes(x = Site_code, y = live_dead_dissimilarity, fill = Site_location)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.8) +
  scale_fill_manual(values = site_colors) +
  labs(x = "Site", y = "Bray-Curtis Dissimilarity") +
  theme_minimal() +
  theme(legend.position = "none")

# Boxplot by Site_location (Panel 2)
plot_location <- ggplot(results_df, aes(x = Site_location, y = live_dead_dissimilarity, fill = Site_location)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.8) +
  scale_fill_manual(values = site_colors) +
  labs(x = "Site Location", y = "Bray-Curtis Dissimilarity") +
  theme_minimal() +
  theme(legend.position = "none")

# Adjust y-position for clarity
max_y <- max(results_df$live_dead_dissimilarity, na.rm = TRUE)
cld_location$y_pos <- max_y + 0.05 * max_y

# Update plot with group letters
plot_location_letters <- plot_location +
  geom_text(data = cld_location,
            aes(x = Site_location, y = y_pos, label = .group),
            size = 4, color = "black")

plot_location_letters

# Combine panels
combined_plot <- plot_site + plot_location_letters
combined_plot

#ggsave("plot_predlivedead_sites.png", combined_plot, width = 12, height = 10, dpi = 300)
```

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}


```














#TO DO:

#Which species contribute most to live-dead discordance?

```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}
#SIMPER Analysis for Live vs Dead Assemblages

#1. Prepare data
str(df_livedead)
df$Condition <- as.factor(df$Condition)

# Identify species columns programmatically
non_species_cols <- c("SampleID", "Site_code", "Site_location", "Sieve_size_mm",
                      "Replicate", "Condition", "live_dead")






species_data_raw <- results_df[, species_cols]

# Check which columns have non-numeric values
sapply(species_data_raw, function(col) any(!is.na(col) & !grepl("^\\d*(\\.\\d+)?$", as.character(col))))

# Create clean species matrix with numeric coercion
species_data <- species_data_raw %>%
  mutate(across(everything(), ~ suppressWarnings(as.numeric(as.character(.)))))

# Check how many NAs appeared
colSums(is.na(species_data))


#2. Run SIMPER analysis
# Run SIMPER to compare live vs dead
group_factor <- as.factor(results_df$live_dead)

simper_result <- simper(species_data, group_factor, permutations = 999)






#1. Prepare the community matrix
# Combine and label the assemblages
simper_data <- bind_rows(
  live_matrix %>% mutate(live_dead = "Live"),
  dead_matrix %>% mutate(live_dead = "Dead")
)

# Keep only species columns
species_matrix <- simper_data[, species_cols]

# Factor indicating live vs dead
group_factor <- simper_data$live_dead

#2. Run SIMPER analysis
simper_result <- vegan::simper(species_matrix, group_factor, permutations = 999)

# View results: this will show species, average contribution, standard deviation, etc.
summary(simper_result)

#3. Extract and visualise key contributors
# Extract results for Live vs Dead
ld_simper <- as.data.frame(simper_result$Live_Dead)

# Add species names
ld_simper$species <- rownames(ld_simper)

# Filter top contributors (e.g. cumulative contribution up to 70%)
top_contributors <- ld_simper %>%
  arrange(desc(average)) %>%
  mutate(cumsum = cumsum(average) / sum(average)) %>%
  filter(cumsum <= 0.7)

# Plot
ggplot(top_contributors, aes(x = reorder(species, average), y = average)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Top Species Contributing to Live-Dead Dissimilarity",
       x = "Species", y = "Average Contribution to Dissimilarity")
```


```{r echo = FALSE, eval = TRUE, cache = TRUE, results = FALSE}


```




















